#!/bin/bash
echo "Cảm ơn bạn đã sử dụng WPTangToc OLS"

if [[ ! -f /etc/cron.d/check-version-wptangtoc-ols.cron ]];then

	if [[ -f /usr/bin/shuf ]];then
		gio=$(shuf -i0-7 -n1)
		gio2=$(shuf -i8-15 -n1)
		gio3=$(shuf -i16-23 -n1)
		if [[ $gio ]];then
			while [ $gio = $gio2 ] || [ $gio = $gio3 ] || [ $gio3 = $gio2 ];do
				gio=$(shuf -i0-7 -n1)
				gio2=$(shuf -i8-15 -n1)
				gio3=$(shuf -i16-23 -n1)
			done
		fi
		phut=$(shuf -i0-59 -n1)
	fi

if [[ $gio = '' ]];then
	gio='0'
	gio2='8'
	gio3='16'
	phut='40'
fi

cat >"/etc/cron.d/check-version-wptangtoc-ols.cron" <<END
$phut $gio,$gio2,$gio3 * * * root /etc/wptt/update/wptt-check-cron-version-update 
END

systemctl restart crond.service
fi

. /etc/wptt/.wptt.conf
if [[ $wptangtoc_ols_giatuan = "1" ]]; then
sed -i "/wptangtoc-ols/d" /root/.bashrc
fi

check=$(cat /etc/group | grep 'wptangtoc-ols:')
if [[ $check = '' ]];then
	groupadd wptangtoc-ols
	mkdir -p /etc/wptt-user
	for entry in $(ls -A /etc/wptt/vhost); do
		domain=$(echo $entry | sed 's/^.//' | sed 's/.conf//')
		path="/usr/local/lsws/$domain/html"
		i=1
		if [[ -d "$path" && -f /etc/wptt/vhost/.$domain.conf ]]; then
			. /etc/wptt/vhost/.$domain.conf
			if [[ $User_name_vhost ]];then
				chown $User_name_vhost:$User_name_vhost /etc/wptt/vhost/.$domain.conf
				usermod -a -G wptangtoc-ols $User_name_vhost
				mkdir -p /home/$User_name_vhost/$domain
				echo ". /etc/wptt-user/wptt-status" >> /home/$User_name_vhost/.bashrc
				echo "alias 1='wptangtoc-user'" >> /home/$User_name_vhost/.bashrc
				echo "alias 11='wptangtoc-user'" >> /home/$User_name_vhost/.bashrc
				ln -s /usr/local/lsws/$NAME/html /home/$User_name_vhost/$domain/public_html
				ln -s /usr/local/lsws/$domain/backup-website /home/$User_name_vhost/$domain/backup-website
				# chown $User_name_vhost:$User_name_vhost /usr/local/backup-website/$domain
				mkdir -p /usr/local/lsws/$domain/backup-website
				chmod 700 /usr/local/lsws/$domain/backup-website
				chown $User_name_vhost:$User_name_vhost /usr/local/lsws/$domain/backup-website
			fi
		fi
	done
	cd
	wget -q http://wptangtoc.com/share/wptangtoc-ols-user.zip --no-check-certificate
	unzip -qo wptangtoc-ols-user.zip
	cd tool-wptangtoc-ols-user
	cd ..
	\cp -rf tool-wptangtoc-ols-user/* /etc/wptt-user
	rm -f wptangtoc-ols-user.zip
	rm -rf tool-wptangtoc-ols-user
	chown -R root:wptangtoc-ols /etc/wptt-user
	chmod -R 750 /etc/wptt-user
	\cp -f /etc/wptt-user/wptangtoc-user /usr/bin
	rm -f /etc/wptt-user/wptangtoc-user
	chown root:wptangtoc-ols /usr/bin/wptangtoc-user
	chmod 750 /usr/bin/wptangtoc-user
fi
