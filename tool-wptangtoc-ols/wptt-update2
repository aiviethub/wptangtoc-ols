#!/bin/bash
# @author: Gia Tuấn
# @website: https://wptangtoc.com
# @email: giatuan@wptangtoc.com
# @since: 2022
. /etc/wptt/.wptt.conf
RED='\033[0;31m'
NC='\033[0m'
nhanh_wptangtoc_ols=$1
echo -e "${RED}-------------------------------------------------------------------------"
echo "-------------------------------------------------------------------------"
echo "Cài đặt lại WPTangToc OLS"
echo "-------------------------------------------------------------------------"
echo -e "--------------------------------------------------------------------------${NC}"

. /etc/wptt/echo-color


# if [[ $nhanh_wptangtoc_ols = "chinhthuc" ]];then
if [[ $beta_wptangtoc_ols = '1' ]];then
	echo "Bạn đang sử dụng phiên bản WPTangToc OLS beta"
else
	echo "Bạn đang sử dụng phiên bản WPTangToc OLS chính thức"
fi

rm -f wptangtoc-ols.zip

if [[ $nhanh_wptangtoc_ols = "chinhthuc" ]];then
	echo "Tiến hành chuyển đổi cài đặt WPTangToc OLS version chính thức"
	_runing "Cài đặt lại WPTangToc OLS"
	wget -q https://wptangtoc.com/share/wptangtoc-ols.zip
	sed -i "/beta_wptangtoc_ols/d" /etc/wptt/.wptt.conf
	call='(chuyển đổi phiên bản chính thức)'
fi

if [[ $nhanh_wptangtoc_ols = "beta" ]];then
	echo "Tiến hành chuyển đổi cài đặt WPTangToc OLS version Beta"
	_runing "Cài đặt lại WPTangToc OLS"
	wget -q https://github.com/wptangtoc/wptangtoc-ols/raw/main/wptangtoc-ols.zip
	sed -i "/beta_wptangtoc_ols/d" /etc/wptt/.wptt.conf
	echo "beta_wptangtoc_ols=1" >>/etc/wptt/.wptt.conf
	if [[ ! -f /tmp/beta-wptangtoc-check ]];then
		echo "" > /tmp/beta-wptangtoc-check
	fi
	call='(chuyển đổi phiên bản beta)'
fi

if [[ $nhanh_wptangtoc_ols = '' ]];then
	if [[ $beta_wptangtoc_ols = '1' ]];then
		echo "Tiến hành cài đặt lại WPTANGTOC version beta"
		wget -q https://github.com/wptangtoc/wptangtoc-ols/raw/main/wptangtoc-ols.zip
	else
		echo "Tiến hành cài đặt lại WPTANGTOC version chính thức"
		wget -q https://wptangtoc.com/share/wptangtoc-ols.zip
	fi
fi


if [[ ! -f wptangtoc-ols.zip ]];then
	_runloi "Cài đặt lại WPTangToc OLS"
	echo "Cập nhật chuyển đổi thất bại"
	exit
fi

unzip -qo wptangtoc-ols.zip
cd tool-wptangtoc-ols
cd ..
\cp -rf tool-wptangtoc-ols/* /etc/wptt/
rm -f wptangtoc-ols.zip
rm -rf tool-wptangtoc-ols
rm -rf toolwptangtocols
chmod -R 740 /etc/wptt
\cp -f /etc/wptt/wptangtoc /usr/bin
rm -f /etc/wptt/wptangtoc
\cp -f /etc/wptt/wptt /usr/bin
rm -f /etc/wptt/wptt

if [[ $beta_wptangtoc_ols = '1' ]];then
	wptangtocols_version=$(curl -s https://wptangtoc.com/share/version-wptangtoc-ols.txt?wptt-update-2-version-beta)
else
	wptangtocols_version=$(curl -s https://wptangtoc.com/share/version-wptangtoc-ols.txt?wptt-update-2)
fi

if [[ $wptangtocols_version = "" ]];then
	wptangtocols_version=$(curl -s https://github.com/wptangtoc/wptangtoc-ols/blob/main/version-wptangtoc-ols.txt | grep 'LC1' | cut -f2 -d '>' | sed 's:</td::g')
fi

sed -i "/version_wptangtoc_ols/d" /etc/wptt/.wptt.conf
echo "version_wptangtoc_ols=$wptangtocols_version" >>/etc/wptt/.wptt.conf
echo "$wptangtocols_version" > /tmp/wptangtoc-ols-version
_rundone "Cài đặt lại WPTangToc OLS"
RED='\033[0;31m'
NC='\033[0m'
echo -e "${RED}
     .:..........................             
      .::::::::::::::::::::::::::::..         
        ..:::::::::::::::::::::::::::::.      
                             ...:::::::::.    
                                  .:::::::.   
          .:::::::.         .       .:::::::  
         .::::::::::::::::::::..      ::::::: 
         ::::::::::::::::::::::::.     ::::::.
        .::::::::::::::::::::::::::.   .:::::.
        .::::::::::::::::::::::::::::  .:::::.
        .::::::::::::::::::::::::::.   .:::::.
         ::::::::::::::::::::::::.     ::::::.
.::::::  .:::::::::::::::::::::.      ::::::. 
          .:::::::.                 .:::::::  
       ::::::::::::.              .:::::::.   
       ......:::::::::...    ...:::::::::.    
               .:::::::::::::::::::::::.      
   ..............::::::::::::::::::..         
  .:::::::::::::................. ${NC}"
echo "-------------------------------------------------------------------------"
echo -e "${RED}-------------------------------------------------------------------------"

echo "Cài đặt WPTangToc OLS $wptangtocols_version $call"

if [[ $beta_wptangtoc_ols = '1' ]];then
	if [[ -f /tmp/beta-wptangtoc-check ]];then
		check_beta_wptangtoc_ols_trung_lap=$(cat /tmp/beta-wptangtoc-check | cut -f2 -d ":")
		check_update_hien_tai_seria=$(cat /etc/wptt/serie)
		if [[ $check_update_hien_tai_seria = $check_beta_wptangtoc_ols_trung_lap ]];then
			echo "Seria bản update ghi đè vẫn như cũ"
		fi
	fi
	echo "Seria:$(cat /etc/wptt/serie)" > /tmp/beta-wptangtoc-check
fi
echo "-------------------------------------------------------------------------"
echo -e "-------------------------------------------------------------------------${NC}"
echo "-------------------------------------------------------------------------"
echo "Phần mềm WPTangToc OLS phát triển bởi: Gia Tuấn"
echo "-------------------------------------------------------------------------"

check_menu_wptangtoc_active=$2
if [[ $check_menu_wptangtoc_active = "98" ]];then
	. /etc/wptt/wptt-update-main 1
fi

