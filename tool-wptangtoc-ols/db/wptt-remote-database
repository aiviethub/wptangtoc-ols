#!/bin/bash
# @author: Gia Tuấn
# @website: https://wptangtoc.com
# @email: giatuan@wptangtoc.com
# @since: 2022

echo ""
echo ""
echo ""
echo "========================================================================="
echo "|Quản lý Database => Bật Remote Database                                |"
echo "========================================================================="
. /etc/wptt/.wptt.conf
. /etc/wptt/tenmien
. /etc/wptt/echo-color

echo ""
echo ""
echo "Lựa chọn website muốn Remote Database: "
echo ""
lua_chon_NAME

if [[ "$NAME" = "0" || "$NAME" = "" ]]; then
    . /etc/wptt/wptt-db-main 1
fi

pathcheck="/etc/wptt/vhost/.$NAME.conf"
if [[ ! -f "$pathcheck" ]]; then
    clear
	echoDo "Tên miền không tồn tại trên hệ thống này"
    sleep 3
    . /etc/wptt/wptt-db-main 1
    exit
fi

_runing "Kích hoạt Remote Database website $NAME"
sed -i "s/#bind-address/bind-address/g" /etc/my.cnf.d/server.cnf
sed -i '/port=/d' /etc/my.cnf.d/server.cnf
echo 'port=18188' >> /etc/my.cnf.d/server.cnf
firewall-cmd --permanent --zone=public --add-port=18188/tcp >/dev/null 2>&1
firewall-cmd --reload >/dev/null 2>&1
systemctl restart mysql.service >/dev/null 2>&1
sed -i 's/3306/18188/g' /etc/fail2ban/jail.local
systemctl restart fail2ban.service
. /etc/wptt/vhost/.$NAME.conf

check_remote=$(mysql -u "$database_admin_username" -p"$database_admin_password" -e "SHOW GRANTS FOR '$DB_User_web'@'%';" 2>/dev/null)
if [[ $check_remote ]];then
	_runloi "Kích hoạt Remote Database website $NAME"
	echoDo "website $NAME đã được kích hoạt remote trước đó rồi"
	check_menu_wptangtoc_active=$1
	if [[ $check_menu_wptangtoc_active = "98" ]];then
		. /etc/wptt/wptt-db-main 1
	fi
	exit
fi

mysql -u "$database_admin_username" -p"$database_admin_password" -e "CREATE USER IF NOT EXISTS '$DB_User_web'@'%' IDENTIFIED BY '$DB_Password_web'"
mysql -u "$database_admin_username" -p"$database_admin_password" -e "GRANT ALL PRIVILEGES ON $DB_Name_web.* TO '$DB_User_web'@'%' WITH GRANT OPTION"
mysql -u "$database_admin_username" -p"$database_admin_password" -e "FLUSH PRIVILEGES"
_runing "Kích hoạt Remote Database website $NAME"

ip=$(curl -s myip.directadmin.com)
if [[ "$ip" = "" ]]; then
  ip=$(curl -s ifconfig.me)
fi

echo "Thông tin tài khoản database website $NAME"
echo "-------------------------------------------------------------------------"
echo "1.  Database_Name           : $DB_Name_web"
echo "2.  User_Name               : $DB_User_web"
echo "3.  PassWord               : $DB_Password_web"
echo "4.  IP               		: $ip"
echo "5.  Port					: 18188"
echo "-------------------------------------------------------------------------"


check_menu_wptangtoc_active=$1
if [[ $check_menu_wptangtoc_active = "98" ]];then
. /etc/wptt/wptt-db-main 1
fi

