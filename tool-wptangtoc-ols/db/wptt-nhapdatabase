#!/bin/bash
# @author: Gia Tuấn
# @website: https://wptangtoc.com
# @email: giatuan@wptangtoc.com
# @since: 2022

echo ""
echo ""
echo ""

check_menu_wptangtoc_active=$1
if [[ $check_menu_wptangtoc_active = "97" ]];then
echo "========================================================================="
echo "|Quản lý sao lưu và khôi phục => Khôi phục Database                                   |"
echo "========================================================================="
else
echo "========================================================================="
echo "|Quản lý Database => Khôi phục Database                                   |"
echo "========================================================================="
fi

. /etc/wptt/.wptt.conf
. /etc/wptt/tenmien
. /etc/wptt/echo-color

echo ""
echo ""
echo "Lựa chọn website bạn muốn khôi phục database:"
echo ""
lua_chon_NAME
pathcheck="/etc/wptt/vhost/.$NAME.conf"
if [[ ! -f "$pathcheck" || "$NAME" = "0" ]]; then

	check_menu_wptangtoc_active=$1
	if [[ $check_menu_wptangtoc_active = "98" ]];then
		. /etc/wptt/wptt-db-main 1
	fi


	check_menu_wptangtoc_active=$1
	if [[ $check_menu_wptangtoc_active = "97" ]];then
		. /etc/wptt/wptt-backup-restore-main 1
	fi

	exit
fi

echo "========================================================================="
echo "Hướng dẫn: Bạn hãy upload database .sql vào thư mục /usr/local/backup-website/$NAME"
echo "========================================================================="


if [ ! $(ls -A /usr/local/backup-website/$NAME | grep ".sql$") ]; then
	clear
	echoDo "Không có file backup database (dinh dang .sql) nào tồn tại."
	echoDo "Vui lòng uploads file backup database dinh dang .sql của bạn vào: /usr/local/backup-website/$NAME/"
	echo
fi


b=1
for entry in $(ls -At /usr/local/backup-website/$NAME | grep ".sql$"); do
b=$((b+1));
done
echo "========================================================================="
echo "Số lượng file backup database của website $NAME: $((b-1))"
echo "========================================================================="


selects=()
for entry in $(ls -At /usr/local/backup-website/$NAME | grep ".sql$"); do
	selects+=("$entry")
done

PS3="
-//- Nhập lựa chọn của bạn [0=Thoát]: "
select select in ${selects[@]}; do
	file=$select
	break
done

if [[ "$file" = "0" ]]; then
	clear

	check_menu_wptangtoc_active=$1
	if [[ $check_menu_wptangtoc_active = "98" ]];then
		. /etc/wptt/wptt-db-main 1
	fi


	check_menu_wptangtoc_active=$1
	if [[ $check_menu_wptangtoc_active = "97" ]];then
		. /etc/wptt/wptt-backup-restore-main 1
	fi

	exit
fi

if [[ "$file" = "" ]]; then
	clear
	echoDo "Không có file backup database nào tồn tại trong thư mục /usr/local/backup-website/$NAME"
	echo "Bạn vui lòng uploadss database định dạng .sql vào thư mục /usr/local/backup-website/$NAME"
	sleep 3
	exit
fi

duong_dan_thu_muc="/usr/local/backup-website/$NAME/$file"


check_file_error=$(du -c $duong_dan_thu_muc | awk '{print $1}' | sed '1d')
if (( $check_file_error < 10 ));then
echo "$file bi loi khong the su dung de khoi phuc database"
echo "Vui long lua chon file database backup khac"
exit
fi

. /etc/wptt/vhost/."$NAME".conf
read -p "Bạn có muốn khôi phục $file vào database website $NAME? (y/n): " dongy

if [[ "$dongy" = "y" ]]; then
	echo "Đang tiến xóa toàn bộ dữ liệu cũ database của website $NAME (database: $DB_Name_web)"
	mysql -u "$database_admin_username" -p"$database_admin_password" -e "DROP DATABASE $DB_Name_web"
	mysql -u "$database_admin_username" -p"$database_admin_password" -e "CREATE DATABASE IF NOT EXISTS $DB_Name_web"

	if [[ -f /usr/local/lsws/$NAME/html/wp-config.php ]]; then
		sed -i "/DB_HOST/s/'[^']*'/'localhost'/2" "/usr/local/lsws/$NAME/html/wp-config.php"
		sed -i "/DB_NAME/s/'[^']*'/'$DB_Name_web'/2" "/usr/local/lsws/$NAME/html/wp-config.php"
		sed -i "/DB_USER/s/'[^']*'/'$DB_User_web'/2" "/usr/local/lsws/$NAME/html/wp-config.php"
		sed -i "/DB_PASSWORD/s/'[^']*'/'$DB_Password_web'/2" "/usr/local/lsws/$NAME/html/wp-config.php"
	fi
else

	check_menu_wptangtoc_active=$1
if [[ $check_menu_wptangtoc_active = "98" ]];then
. /etc/wptt/wptt-db-main 1
fi


check_menu_wptangtoc_active=$1
if [[ $check_menu_wptangtoc_active = "97" ]];then
. /etc/wptt/wptt-backup-restore-main 1
fi
	exit
fi

sleep 3
echo "Đang tiến hành nhập dữ liệu database cho website $NAME"
echo ""
echo "Vui lòng đợi..."
echo ""

mysql -h localhost -u "$database_admin_username" -p"$database_admin_password" "$DB_Name_web" <$duong_dan_thu_muc


clear
echoDone "Hoàn tất khôi phục nhập dữ liệu database cho website $NAME ($DB_Name_web)"


check_menu_wptangtoc_active=$1
if [[ $check_menu_wptangtoc_active = "98" ]];then
. /etc/wptt/wptt-db-main 1
fi


check_menu_wptangtoc_active=$1
if [[ $check_menu_wptangtoc_active = "97" ]];then
. /etc/wptt/wptt-backup-restore-main 1
fi

