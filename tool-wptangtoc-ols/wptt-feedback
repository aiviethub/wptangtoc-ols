#!/bin/bash
#
#
# @author: Gia Tuấn
# @website: https://wptangtoc.com
# @since: 2021
clear

echo -e "+-----------------------------------------------------------------------+"
echo "|                                                                       |"
echo "|                        Gửi yêu cầu đến Gia Tuấn		        |"
echo "|                                                                       |"
echo -e "+-----------------------------------------------------------------------+"

read -p "Xác nhận bạn muốn gửi yêu cầu đến cho mình? (y/n): " dongy
if [[ "$dongy" != "y" ]];then
wptangtoc
exit
fi

read -p "Nhập nội dung gửi đến mình: " noidung

. /etc/wptt/.wptt.conf

if [[ "$so_dien_thoai" = "" ]]; then

read -p "Hãy nhập số điện thoại của bạn để mình dễ dàng liên hệ với bạn: " sodienthoai
pat="^[0-9]{10}$"
while [[ ! $sodienthoai =~ $pat ]]
    do
    echo "Đây không phải là số điện thoại"
    sleep 3
    wptangtoc
    exit
done
echo "so_dien_thoai=$sodienthoai" >> /etc/wptt/.wptt.conf
fi

telegram_api_giatuan=$(curl -s https://wptangtoc.com/share/feedback.txt | grep "api" | cut -f2 -d "=")
telegram_id_giatuan=$(curl -s https://wptangtoc.com/share/feedback.txt | grep "id" | cut -f2 -d "=")

client_ip=$(echo $SSH_CLIENT | awk '{ print $1}')
vps_ip=$(curl -s myip.directadmin.com)
if [[ "$vps_ip" = "" ]]; then
    vps_ip=$(curl -s ifconfig.me)
fi
date="$(date "+%d-%m-%Y %H:%M")"
info_ip=https://ipinfo.io/${client_ip}
text="
Thông tin yêu cầu WPTangToc OLS
-------------------------------------
Nội dung: $noidung
-------------------------------------
IP Máy trạm: *${client_ip}* - [Thông tin chi tiết](${info_ip})
IP webserver: $vps_ip
Thời điểm: ${date}
Website: `for entry in $(ls -A /etc/wptt/vhost); do
    domain=$( echo $entry | sed 's/^.//' | sed 's/.conf//')
    path="/usr/local/lsws/$domain/html"
    i=1

    if [[ -d "$path" ]]; then
         echo "$domain ,"
    fi
  done
`
-------------------------------------
WPTangToc OLS phiên bản : $version_wptangtoc_ols
Phát triển bởi [Gia Tuấn](https://wptangtoc.com/gia-tuan)
"
url_tele="https://api.telegram.org/bot${telegram_api_giatuan}/sendMessage"
curl -s -d "chat_id=$telegram_id_giatuan&text=${text}&disable_web_page_preview=true&parse_mode=markdown" $url_tele > /dev/null
clear
echo "Nội dung tin nhắn đã gửi đến Gia Tuấn (Tác giả phần mềm WPTangToc OLS)"
echo "Cảm ơn bạn đã gửi yêu cầu đến với mình"
sleep 5
wptangtoc
