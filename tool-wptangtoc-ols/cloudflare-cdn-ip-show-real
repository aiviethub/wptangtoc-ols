#!/bin/bash
function huong_dan(){
T√≠nh nƒÉng Hi·ªÉn th·ªã IP real Cloudflare CDN trong WPTangToc OLS l√† m·ªôt c√¥ng c·ª• gi√∫p b·∫°n x√°c minh ho·∫∑c c·∫•u h√¨nh ƒë·ªÉ m√°y ch·ªß web OpenLiteSpeed c·ªßa b·∫°n c√≥ th·ªÉ nh·∫≠n di·ªán v√† ghi l·∫°i ƒë·ªãa ch·ªâ IP th·ª±c c·ªßa ng∆∞·ªùi d√πng khi website ƒëang s·ª≠ d·ª•ng d·ªãch v·ª• CDN c·ªßa Cloudflare.

ü§î T·∫°i sao c·∫ßn quan t√¢m IP th·ª±c khi d√πng Cloudflare?
Khi website c·ªßa b·∫°n s·ª≠ d·ª•ng Cloudflare, t·∫•t c·∫£ l∆∞u l∆∞·ª£ng truy c·∫≠p s·∫Ω ƒëi qua m·∫°ng l∆∞·ªõi c·ªßa Cloudflare tr∆∞·ªõc khi ƒë·∫øn m√°y ch·ªß g·ªëc. Do ƒë√≥, trong log c·ªßa m√°y ch·ªß web, ƒë·ªãa ch·ªâ IP c·ªßa ng∆∞·ªùi truy c·∫≠p th∆∞·ªùng s·∫Ω hi·ªÉn th·ªã l√† IP c·ªßa Cloudflare, ch·ª© kh√¥ng ph·∫£i IP th·ª±c c·ªßa kh√°ch truy c·∫≠p. ƒêi·ªÅu n√†y g√¢y kh√≥ khƒÉn cho vi·ªác:

Ph√¢n t√≠ch log ch√≠nh x√°c.
 * √Åp d·ª•ng c√°c quy t·∫Øc b·∫£o m·∫≠t d·ª±a tr√™n IP [v√≠ d·ª•: ch·∫∑n IP, gi·ªõi h·∫°n truy c·∫≠p].
 * Ho·∫°t ƒë·ªông c·ªßa m·ªôt s·ªë plugin ho·∫∑c ·ª©ng d·ª•ng c·∫ßn IP th·ª±c c·ªßa ng∆∞·ªùi d√πng.
 * ƒê·∫£m b·∫£o D·ªØ li·ªáu Ch√≠nh x√°c: Gi√∫p c√°c c√¥ng c·ª• ph√¢n t√≠ch, b·∫£o m·∫≠t [nh∆∞ Fail2Ban,CSF,Nftables,Firewalld...] v√† ·ª©ng d·ª•ng tr√™n website ho·∫°t ƒë·ªông ch√≠nh x√°c v·ªõi IP th·ª±c c·ªßa ng∆∞·ªùi d√πng.

‚ú® L·ª£i √≠ch:
 * Log ch√≠nh x√°c: Ghi l·∫°i ƒë√∫ng IP c·ªßa kh√°ch truy c·∫≠p trong log m√°y ch·ªß.
 * B·∫£o m·∫≠t hi·ªáu qu·∫£ h∆°n: C√°c c√¥ng c·ª• b·∫£o m·∫≠t d·ª±a tr√™n IP ho·∫°t ƒë·ªông ƒë√∫ng ƒë·∫Øn.
 * Ph√¢n t√≠ch d·ªØ li·ªáu t·ªët h∆°n: Hi·ªÉu r√µ h∆°n v·ªÅ ngu·ªìn g·ªëc l∆∞u l∆∞·ª£ng truy c·∫≠p.
T√≥m l·∫°i, t√≠nh nƒÉng Hi·ªÉn th·ªã IP real Cloudflare CDN trong WPTangToc OLS r·∫•t quan tr·ªçng ƒë·ªÉ ƒë·∫£m b·∫£o m√°y ch·ªß c·ªßa b·∫°n ho·∫°t ƒë·ªông ch√≠nh x√°c v√† hi·ªáu qu·∫£ khi website ƒë∆∞·ª£c b·∫£o v·ªá v√† tƒÉng t·ªëc b·ªüi Cloudflare, b·∫±ng c√°ch gi√∫p m√°y ch·ªß nh·∫≠n di·ªán ƒë√∫ng ƒë·ªãa ch·ªâ IP g·ªëc c·ªßa kh√°ch truy c·∫≠p.
}


if [[ $2 = 'premium' ]];then
unset key_activate
. /etc/wptt/.wptt.conf
if [[ -z $key_activate ]];then
	echo "T√≠nh nƒÉng n√†y l√† t√≠nh nƒÉng Premium b·∫°n ph·∫£i mua Active key m·ªõi c√≥ th·ªÉ s·ª≠ d·ª•ng ƒë∆∞·ª£c"
	echo "B·∫°n h√£y activate key th√¨ s·∫Ω ƒë∆∞·ª£c s·ª≠ d·ª•ng t·∫•t c·∫£ c√°c t√≠nh nƒÉng trong add ons"
	check_menu_wptangtoc_active=$1
	if [[ $check_menu_wptangtoc_active = "98" ]];then
		. /etc/wptt/wptt-add-one-main 1
	fi
	exit;
fi
fi


echo "Show IP th·ª±c client khi d√πng Cloudflare : $(date '+%d-%m-%Y %H:%M')" >> /var/log/wptangtoc-ols.log

sed -i '/useIpInProxyHeader/d' /usr/local/lsws/conf/httpd_config.conf
sed -i '/adminEmails/i useIpInProxyHeader     2' /usr/local/lsws/conf/httpd_config.conf
ip_block_by_litespeed=$(cat /usr/local/lsws/conf/httpd_config.conf | grep 'deny')
#xoa block accessControl trong cau hinh
sed -i -e '/^accessControl/,/^}$/d' /usr/local/lsws/conf/httpd_config.conf

#https://www.cloudflare.com/ips/ ip cloudflare
if [[ $ip_block_by_litespeed = '' ]];then
echo '
accessControl  {
  allow                   ALL, 103.21.244.0/22T, 103.22.200.0/22T, 103.31.4.0/22T, 104.16.0.0/13T, 104.24.0.0/14T, 108.162.192.0/18T, 131.0.72.0/22T, 141.101.64.0/18T, 162.158.0.0/15T, 172.64.0.0/13T, 173.245.48.0/20T, 188.114.96.0/20T, 190.93.240.0/20T, 197.234.240.0/22T, 198.41.128.0/17T
}
' >> /usr/local/lsws/conf/httpd_config.conf
else
echo '
accessControl  {
  allow                   ALL, 103.21.244.0/22T, 103.22.200.0/22T, 103.31.4.0/22T, 104.16.0.0/13T, 104.24.0.0/14T, 108.162.192.0/18T, 131.0.72.0/22T, 141.101.64.0/18T, 162.158.0.0/15T, 172.64.0.0/13T, 173.245.48.0/20T, 188.114.96.0/20T, 190.93.240.0/20T, 197.234.240.0/22T, 198.41.128.0/17T
'$ip_block_by_litespeed'
}
' >> /usr/local/lsws/conf/httpd_config.conf
fi
/usr/local/lsws/bin/lswsctrl restart >/dev/null 2>&1
echo "Ho√†n t·∫•t setup real ip cloudflare cdn"
