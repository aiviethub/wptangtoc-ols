#!/bin/bash
echo "========================================================================="
echo "|Quản lý bảo mật => CSF => Cài Đặt                                      |"
echo "========================================================================="

if [[ ! -f /etc/csf/csf.conf ]];then
yum install perl-libwww-perl.noarch perl-Time-HiRes -y
cd /usr/src/
if [[ -f /usr/src/csf.tgz ]];then
rm -f /usr/src/csf.tgz
fi

wget https://download.configserver.com/csf.tgz --no-check-certificate
tar -xzf csf.tgz
cd csf
sh install.sh
cd /usr/local/csf/bin/
perl /usr/local/csf/bin/csftest.pl



systemctl stop firewalld
systemctl disable firewalld
systemctl mask firewalld

sed -i 's/TESTING = "1"/TESTING = "0"/g' /etc/csf/csf.conf

#bat quic http/3
if [[ $(cat /etc/csf/csf.conf | grep '^UDP_OUT' | grep "$port_ols,") = '' ]];then
sed -i "s/^UDP_OUT = \"/UDP_OUT = \"443,/g" /etc/csf/csf.conf
fi

if [[ $(cat /etc/csf/csf.conf | grep '^UDP_IN' | grep "$port_ols,") = '' ]];then
sed -i "s/^UDP_IN = \"/UDP_IN = \"443,/g" /etc/csf/csf.conf
fi

if [[ $(cat /etc/csf/csf.conf | grep '^TCP_IN' | grep "$port_ols,") = '' ]];then
	sed -i "s/^TCP_IN = \"/TCP_IN = \"443,/g" /etc/csf/csf.conf
fi
if [[ $(cat /etc/csf/csf.conf | grep '^TCP_OUT' | grep "$port_ols,") = '' ]];then
	sed -i "s/^TCP_OUT = \"/TCP_OUT = \"443,/g" /etc/csf/csf.conf
fi


# sed -i 's/# .googlebot.com/.googlebot.com/g' /etc/csf/csf.rignore
# sed -i 's/# .crawl.yahoo.net/.crawl.yahoo.net/g' /etc/csf/csf.rignore
# sed -i 's/# .search.msn.com/.search.msn.com/g' /etc/csf/csf.rignore
# echo ".lscache_runner" >> /etc/csf/csf.rignore
# echo ".letsencrypt.org" >> /etc/csf/csf.rignore
# echo ".bing.com" >> /etc/csf/csf.rignore
# echo ".wptangtoc.com" >> /etc/csf/csf.rignore
# echo ".google.com" >> /etc/csf/csf.rignore
# echo ".facebook.com" >> /etc/csf/csf.rignore
# sed -i '/.googlebot.com and /d' /etc/csf/csf.rignore

echo '###############################################################################
# Copyright 2006-2018, Way to the Web Limited
# URL: http://www.configserver.com
# Email: sales@waytotheweb.com
###############################################################################
# The following is a list of domains and partial domain that lfd process
# tracking will ignore based on reverse and forward DNS lookups. An example of
# its use is to prevent web crawlers from being blocked by lfd, e.g.
#
# You must use either a Fully Qualified Domain Name (FQDN) or a unique ending
# subset of the domain name which must begin with a dot (wildcards are NOT
# otherwise permitted)
#
# For example, the following are all valid entries:
# www.configserver.com
# .configserver.com
# .configserver.co.uk
.googlebot.com
.crawl.yahoo.net
.search.msn.com
#
# The following are NOT valid entries:
# *.configserver.com
# *google.com
# google.com (unless the lookup is EXACTLY google.com with no subdomain
#
# When a candidate IP address is inspected a reverse DNS lookup is performed on
# the IP address. A forward DNS lookup is then performed on the result from the
# reverse DNS lookup. The IP address will only be ignored if:
#
# 1. The results of the final lookup matches the original IP address
# AND
# 2a. The results of the rDNS lookup matches the FQDN
# OR
# 2b. The results of the rDNS lookup matches the partial subset of the domain
#
# Note: If the DNS lookups are too slow or do not return the expected results
# the IP address will be counted towards the blocking trigger as normal
#
.lscache_runner
.letsencrypt.org
.bing.com
.wptangtoc.com
.google.com
.facebook.com' > /etc/csf/csf.rignore

echo "216.239.32.0/19 # Googlebot
64.233.160.0/19 # Googlebot
72.14.192.0/18 # Googlebot
209.85.128.0/17 # Googlebot
66.102.0.0/20 # Googlebot
74.125.0.0/16 # Googlebot
66.249.64.0/19 #Googlebotallow" >> /etc/csf/csf.allow

# sed -i '/TESTING = /d' /etc/csf/csf.conf
# sed -i '/while this is enable/a TESTING = "0"' /etc/csf/csf.conf
systemctl start csf
systemctl start lfd
systemctl enable csf
systemctl enable lfd

csf -e >/dev/null 2>&1
#add ip wptangtoc vao danh sách trắng
csf -a $(host wptangtoc.com | grep -Eo -m 1 '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}') >/dev/null 2>&1

csf -r >/dev/null 2>&1

echo "Hoàn tất cài đặt CSF"
else
echo "Bạn đã cài đặt trước đó rồi"
fi

check_menu_wptangtoc_active=$1
if [[ $check_menu_wptangtoc_active = "98" ]];then
. /etc/wptt/bao-mat/csf-main 1
fi

