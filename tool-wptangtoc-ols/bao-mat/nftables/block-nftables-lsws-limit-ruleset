#!/bin/bash
#chuyển ip block từ layer7 lsws sang layer 3,4 nftables để cải thiện hiệu suất, giảm tải máy chủ
ip_hien_tai_bi_lsws_block=$(cat /tmp/lshttpd/.rtreport* | grep 'BLOCKED_IP:' | tr ',' '\n' | grep -E -o '(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)'| sort -u)
for ip in ${ip_hien_tai_bi_lsws_block[@]};do
/usr/sbin/nft add element ip blackblock blackaction "{$ip timeout 16h}" >/dev/null
done

#cat <(crontab -l) | sed "/block-nftables-lsws-limit-ruleset/d" | crontab -
#cat <(crontab -l) <(echo "*/5 * * * * /bin/bash /etc/wptt/bao-mat/nftables/block-nftables-lsws-limit-ruleset >/dev/null 2>&1") | crontab -
#systemctl restart crond

