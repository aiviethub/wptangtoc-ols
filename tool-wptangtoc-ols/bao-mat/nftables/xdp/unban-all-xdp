#!/bin/bash

set -e

if ! command -v jq &>/dev/null; then
  echo "Lỗi: Lệnh 'jq' không tồn tại. Vui lòng cài đặt bằng lệnh:"
  echo "sudo dnf install jq -y"
  exit 1
fi

MAP_NAME="blacklist_map"
MAP_ID=$(sudo bpftool map list | grep "$MAP_NAME" | awk '{print $1}' | sed 's/://')

if [ -z "$MAP_ID" ]; then
  echo "Lỗi: Không tìm thấy '$MAP_NAME'."
  exit 1
fi

echo "Tìm thấy '$MAP_NAME' với ID: $MAP_ID"

# *** THAY ĐỔI DUY NHẤT NẰM Ở ĐÂY ***
# Sửa lại lệnh jq để giữ lại tiền tố "0x" bằng cách dùng join(" ")
HEX_KEY_LIST=$(sudo bpftool -j map dump id "$MAP_ID" | jq -r '.[].key | join(" ")')

if [ -z "$HEX_KEY_LIST" ]; then
  echo "Thông báo: '$MAP_NAME' đã trống. ✅"
  exit 0
fi

echo "Bắt đầu quá trình gỡ chặn tất cả IP..."

# Vòng lặp này bây giờ sẽ nhận được input chuẩn: "0x7b 0x19 0x21 0x02"
echo "$HEX_KEY_LIST" | while read -r key_line; do
  echo "  -> Đang xóa IP với key: $key_line"
  sudo bpftool map delete id "$MAP_ID" key $key_line
done

echo "Hoàn tất! Đã xóa thành công toàn bộ IP khỏi danh sách đen. 👍"
