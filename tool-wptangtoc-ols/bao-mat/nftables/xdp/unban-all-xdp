#!/bin/bash

set -e

# Hàm để xóa sạch một BPF map được chỉ định
clear_bpf_map() {
  local MAP_NAME=$1
  echo "--- Đang xử lý map: $MAP_NAME ---"
  MAP_ID=$(sudo bpftool map list | grep "$MAP_NAME" | awk '{print $1}' | sed 's/://' || true)
  if [ -z "$MAP_ID" ]; then
    echo "Không tìm thấy map '$MAP_NAME'. Bỏ qua."
    return
  fi
  echo "Tìm thấy '$MAP_NAME' với ID: $MAP_ID"
  HEX_KEY_LIST=$(sudo bpftool -j map dump id "$MAP_ID" | jq -r '.[].key | join(" ")')
  if [ -z "$HEX_KEY_LIST" ]; then
    echo "Thông báo: Map '$MAP_NAME' đã trống. ✅"
    return
  fi
  echo "Bắt đầu quá trình gỡ chặn IP trong map '$MAP_NAME'..."
  echo "$HEX_KEY_LIST" | while read -r key_line; do
    echo "  -> Đang xóa IP với key: $key_line"
    sudo bpftool map delete id "$MAP_ID" key $key_line
  done
  echo "Đã xóa thành công nội dung map: $MAP_NAME"
}

# --- PHẦN CHÍNH CỦA SCRIPT ---
if ! command -v jq &>/dev/null; then
  echo "Lỗi: Lệnh 'jq' không tồn tại."
  exit 1
fi

# Định nghĩa danh sách các map cần xóa với tên đã rút gọn
MAPS_TO_CLEAR=("log_blacklist" "rl_blacklist")

for map_name in "${MAPS_TO_CLEAR[@]}"; do
  clear_bpf_map "$map_name"
done

echo "--------------------------------------"
echo "✅ Hoàn tất! Đã gỡ chặn tất cả IP bị chặn."
