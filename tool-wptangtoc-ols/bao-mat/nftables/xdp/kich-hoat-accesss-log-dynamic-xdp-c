#!/bin/bash

check_xdp_action=$(ip a | grep 'xdp')
if [[ $check_xdp_action = '' ]]; then
  echo "Chưa kích hoạt xdp"
  exit
fi

. /etc/wptt/tenmien
echo ""
echo ""
echo "Lựa chọn triển khai ddos xdp block access log dynamic:"
echo ""
lua_chon_NAME
. /etc/wptt/echo-color
if [[ "$NAME" = "0" || "$NAME" = "" ]]; then
  . /etc/wptt/wptt-wordpress-main 1
fi

pathcheck="/etc/wptt/vhost/.$NAME.conf"
if [[ ! -f "$pathcheck" ]]; then
  clear
  echoDo "Tên miền không tồn tại trên hệ thống này"
  sleep 3
  . /etc/wptt/wptt-wordpress-main 1
  exit
fi

if [[ $(cat /usr/local/lsws/conf/httpd_config.conf | grep 'xdp-blocker-logger') ]]; then
  read -p "bạn có muốn tắt xdp-blocker-logger (y/n): " dongytat
  if [[ $dongytat = 'y' ]]; then
    sed -i -e '/^accesslog /,/^}$/d' /usr/local/lsws/conf/httpd_config.conf
    echo "accesslog logs/access.log {
		rollingSize             10M
		keepDays                30
		compressArchive         0
}" >>/usr/local/lsws/conf/httpd_config.conf

    sed -i -e '/^extprocessor xdp-blocker-logger/,/^}$/d' /usr/local/lsws/conf/httpd_config.conf

    sed -i -e '/^errorlog /,/^}$/d' /usr/local/lsws/conf/vhosts/"$NAME"/"$NAME".conf
    sed -i -e '/^accesslog /,/^}$/d' /usr/local/lsws/conf/vhosts/"$NAME"/"$NAME".conf
    echo '
errorlog $VH_ROOT/logs/error.log {
useServer               1
logLevel                ERROR
rollingSize             10M
}

accesslog $VH_ROOT/logs/access.log {
useServer               0
rollingSize             10M
keepDays                30
compressArchive         1
}' >>/usr/local/lsws/conf/vhosts/"$NAME"/"$NAME".conf

    rm -f /usr/local/bin/anti-access
    systemctl restart lsws
  fi
  exit
fi

if [[ $(cat /usr/local/lsws/conf/httpd_config.conf | grep 'xdp-blocker-logger') = '' ]]; then
  read -p "bạn có muốn bật xdp-blocker-logger (y/n): " dongybat
  if [[ $dongybat = 'y' ]]; then
    mkdir -p /usr/local/lsws/$NAME/bao-mat
    cp -f /etc/wptt/bao-mat/nftables/xdp/log-xdp-anti-access.c /usr/local/lsws/$NAME/bao-mat/anti-access.c
    cd /usr/local/lsws/$NAME/bao-mat
    rm -f anti-access
    # gcc -o anti-access anti-access.c -lbpf
    gcc -O2 anti-access.c -o anti-access -lbpf

    if [[ ! -f anti-access ]]; then
      sleep 2
      gcc -O2 anti-access.c -o anti-access -lbpf
    fi

    # gcc -O2 anti-access.c -o anti-access -lbpf
    rm -f /usr/local/bin/anti-access
    mv /usr/local/lsws/$NAME/bao-mat/anti-access /usr/local/bin
    chmod +x /usr/local/bin/anti-access

    sudo chmod u+s /usr/local/bin/anti-access
    setenforce 0
    sed -i 's/=enforcing/=disabled/g' /etc/selinux/config
    systemctl daemon-reload

    echo "Hoàn tất install xdp xdp block access log dynamic website $NAME"

    sed -i -e '/^accesslog /,/^}$/d' /usr/local/lsws/conf/httpd_config.conf
    echo '
accesslog logs/access.log {
  pipedLogger             xdp-blocker-logger
  rollingSize             10M
  keepDays                30
  compressArchive         0
}' >>/usr/local/lsws/conf/httpd_config.conf

    sed -i -e '/^extprocessor xdp-blocker-logger/,/^}$/d' /usr/local/lsws/conf/httpd_config.conf
    echo 'extprocessor xdp-blocker-logger {
  type                    logger
  address                 uds://tmp/xdp-logger.sock
  maxConns                100
  path                    /usr/local/bin/anti-access
  instances               1
}
' >>/usr/local/lsws/conf/httpd_config.conf

    sed -i -e '/^accesslog /,/^}$/d' /usr/local/lsws/conf/vhosts/"$NAME"/"$NAME".conf
    echo 'accesslog $VH_ROOT/logs/access.log {
  useServer               1
  rollingSize             10M
  keepDays                30
  compressArchive         1
}
' >>/usr/local/lsws/conf/vhosts/"$NAME"/"$NAME".conf
    systemctl restart lsws
  fi
  exit
fi
