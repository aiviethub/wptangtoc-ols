#!/bin/bash

. /etc/wptt/echo-color
if [ -f /etc/csf/csf.conf ]; then
	echoDo "Bạn đang sử dụng CSF rồi không thể dùng tính năng này"
fi

#check lệnh: firewall-cmd --permanent --direct --get-all-rules
echo 'firewalld giới hạn tường lửa chống ddos'
echo 'options xt_recent ip_pkt_list_tot=30' > /etc/modprobe.d/xt.conf

#--seconds 60 --hitcount 30 ý nghĩa là tối đa ip trong 60 giây tối đa yêu cầu không quá 30 yêu cầu, 30 nếu muốn có thể hạ xuống thấp hơn nếu muốn
modprobe xt_recent
/bin/firewall-cmd --permanent --direct --remove-rule ipv4 filter INPUT_direct \
  0 -p tcp --dport 80 -m state --state NEW -m recent --set
/bin/firewall-cmd --permanent --direct --remove-rule ipv4 filter INPUT_direct \
  1 -p tcp --dport 80 -m state --state NEW -m recent --update \
  --seconds 60 --hitcount 30 -j REJECT --reject-with tcp-reset

/bin/firewall-cmd --permanent --direct --remove-rule ipv4 filter INPUT_direct \
  0 -p tcp --dport 443 -m state --state NEW -m recent --set
/bin/firewall-cmd --permanent --direct --remove-rule ipv4 filter INPUT_direct \
  1 -p tcp --dport 443 -m state --state NEW -m recent --update \
  --seconds 60 --hitcount 30 -j REJECT --reject-with tcp-reset


/bin/firewall-cmd --permanent --direct --remove-rule ipv6 filter INPUT_direct \
  0 -p tcp --dport 80 -m state --state NEW -m recent --set
/bin/firewall-cmd --permanent --direct --remove-rule ipv6 filter INPUT_direct \
  1 -p tcp --dport 80 -m state --state NEW -m recent --update \
  --seconds 60 --hitcount 30 -j REJECT --reject-with tcp-reset

/bin/firewall-cmd --permanent --direct --remove-rule ipv6 filter INPUT_direct \
  0 -p tcp --dport 443 -m state --state NEW -m recent --set
/bin/firewall-cmd --permanent --direct --remove-rule ipv6 filter INPUT_direct \
  1 -p tcp --dport 443 -m state --state NEW -m recent --update \
  --seconds 60 --hitcount 30 -j REJECT --reject-with tcp-reset



/bin/firewall-cmd --permanent --direct --add-rule ipv4 filter INPUT_direct \
  0 -p tcp --dport 80 -m state --state NEW -m recent --set
/bin/firewall-cmd --permanent --direct --add-rule ipv4 filter INPUT_direct \
  1 -p tcp --dport 80 -m state --state NEW -m recent --update \
  --seconds 60 --hitcount 30 -j REJECT --reject-with tcp-reset

/bin/firewall-cmd --permanent --direct --add-rule ipv4 filter INPUT_direct \
  0 -p tcp --dport 443 -m state --state NEW -m recent --set
/bin/firewall-cmd --permanent --direct --add-rule ipv4 filter INPUT_direct \
  1 -p tcp --dport 443 -m state --state NEW -m recent --update \
  --seconds 60 --hitcount 30 -j REJECT --reject-with tcp-reset


/bin/firewall-cmd --permanent --direct --add-rule ipv6 filter INPUT_direct \
  0 -p tcp --dport 80 -m state --state NEW -m recent --set
/bin/firewall-cmd --permanent --direct --add-rule ipv6 filter INPUT_direct \
  1 -p tcp --dport 80 -m state --state NEW -m recent --update \
  --seconds 60 --hitcount 30 -j REJECT --reject-with tcp-reset

/bin/firewall-cmd --permanent --direct --add-rule ipv6 filter INPUT_direct \
  0 -p tcp --dport 443 -m state --state NEW -m recent --set
/bin/firewall-cmd --permanent --direct --add-rule ipv6 filter INPUT_direct \
  1 -p tcp --dport 443 -m state --state NEW -m recent --update \
  --seconds 60 --hitcount 30 -j REJECT --reject-with tcp-reset


firewall-cmd --reload
echo 'hoàn tất'
