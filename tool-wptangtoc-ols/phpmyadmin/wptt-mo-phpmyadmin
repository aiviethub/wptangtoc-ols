#!/bin/bash
#
#
# @author: Gia Tuáº¥n
# @website: https://wptangtoc.com
# @since: 2021

. /etc/wptt/.wptt.conf

if [[ $id_dang_nhap_phpmyadmin ]];then
echo "Ban da kich hoat phpmyadmin truoc do roi"
exit
fi


phpmyadmin_version=5.1.1
cd /usr/local/lsws/$Website_chinh/html
wget -P /usr/local/lsws/$Website_chinh/html  https://files.phpmyadmin.net/phpMyAdmin/$phpmyadmin_version/phpMyAdmin-$phpmyadmin_version-all-languages.zip
unzip /usr/local/lsws/$Website_chinh/html/phpMyAdmin-$phpmyadmin_version-all-languages.zip
mv /usr/local/lsws/$Website_chinh/html/phpMyAdmin-$phpmyadmin_version-all-languages /usr/local/lsws/$Website_chinh/html/phpmyadmin
rm -f /usr/local/lsws/$Website_chinh/html/phpMyAdmin-$phpmyadmin_version-all-languages.zip
chown -R nobody:nobody /usr/local/lsws/$Website_chinh/html/phpmyadmin

NAME="${Website_chinh}php"
NAME2="${Website_chinh}"
  mkdir -p /usr/local/lsws/"$NAME2"/passwd
  Post_Install_Regenerate_Webadmin_Console_Passwd() {
    if [[ "$Server_Edition" = "OLS" ]]; then
      PHP_Command="admin_php"
    else
      PHP_Command="admin_php5"
    fi

    Webadmin_Pass=$(
      head /dev/urandom | tr -dc A-Za-z0-9 | head -c 36
      echo ''
    )
    id_ols_admin=$(
      date +%s | sha256sum | base64 | head -c 24
      echo
    )
    Encrypt_string=$(/usr/local/lsws/admin/fcgi-bin/admin_php -q /usr/local/lsws/admin/misc/htpasswd.php "${Webadmin_Pass}")
    echo "" >/usr/local/lsws/"$NAME"/passwd/.phpmyadmin
    echo "$id_ols_admin:$Encrypt_string" >/usr/local/lsws/"$NAME2"/passwd/.phpmyadmin
    echo "tai khoan username/password da cap nhat thanh cong!"
  }
  Post_Install_Regenerate_Webadmin_Console_Passwd

check=$(cat /usr/local/lsws/conf/vhosts/"$NAME2"/"$NAME2".conf | grep -c 'realm')

if [[ $check = "0" ]];then
echo 'realm '$NAME' {

  userDB  {
    location              /usr/local/lsws/'$NAME2'/passwd/.phpmyadmin
  }
}' >>/usr/local/lsws/conf/vhosts/"$NAME2"/"$NAME2".conf
else
sed -i '/realm/a userDB  {\
    location              /usr/local/lsws/'$NAME2'/passwd/.phpmyadmin\
  }' /usr/local/lsws/conf/vhosts/"$NAME2"/"$NAME2".conf
fi

echo '
context exp:phpmyadmin {
  location                $DOC_ROOT/$0
  allowBrowse             1
  realm                   '$NAME'

  accessControl  {
    allow                 ALL
  }

  rewrite  {

  }
  addDefaultCharset	  off

  phpIniOverride  {

  }
}' >>/usr/local/lsws/conf/vhosts/"$NAME2"/"$NAME2".conf

  echo "id_dang_nhap_phpmyadmin=$id_ols_admin
password_dang_nhap_phpmyadmin=$Webadmin_Pass" >>/etc/wptt/.wptt.conf
  chown nobody:nobody /usr/local/lsws/"$NAME2"/passwd/.phpmyadmin
  chmod 400 /usr/local/lsws/"$NAME2"/passwd/.phpmyadmin
  /usr/local/lsws/bin/lswsctrl restart >/dev/null 2>&1
  echo "============================================================================="
  echo "da hoan tat kich hoat bao mat phpmyadmin"
  echo "============================================================================="
  echo "ban hay luu tru thong tin nay lai de su dung"
  echo "============================================================================="
  echo "id dang nhap : $id_ols_admin"
  echo "password dang nhap : $Webadmin_Pass"
  echo "============================================================================="
  echo "ban co the xem lai tai khoan: /etc/wptt/.$NAME2.conf"
  echo "Hoac xem lai tai khoan ben trong menu wptangtoc ols"
echo "Hoan tat cai dat phpmyadmin"

