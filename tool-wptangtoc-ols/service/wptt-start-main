#!/bin/bash
# @author: Gia Tuấn
# @website: https://wptangtoc.com
# @email: giatuan@wptangtoc.com
# @since: 2024
# @modified: 2025-03-30 - Removed server reboot, changed restart to start

# --- Khởi tạo và tải cấu hình ---
# Tải cấu hình chính
if [[ -f "/etc/wptt/.wptt.conf" ]]; then
    . "/etc/wptt/.wptt.conf"
else
    # Gán ngôn ngữ mặc định nếu không có file config
    ngon_ngu='vi'
    echo "Cảnh báo: Không tìm thấy tệp cấu hình /etc/wptt/.wptt.conf. Sử dụng ngôn ngữ mặc định 'vi'."
fi

# Xác định và tải file ngôn ngữ
if [[ -z "$ngon_ngu" ]]; then # Kiểm tra chuỗi rỗng an toàn hơn
    ngon_ngu='vi'
fi
lang_file="/etc/wptt/lang/${ngon_ngu}.sh"
if [[ -f "$lang_file" ]]; then
    . "$lang_file"
else
    echo "Cảnh báo: Không tìm thấy tệp ngôn ngữ '$lang_file'. Sử dụng tiếng Việt mặc định."
    # Cố gắng tải tiếng Việt nếu có
    if [[ -f "/etc/wptt/lang/vi.sh" ]]; then
        . "/etc/wptt/lang/vi.sh"
    else
        echo "Lỗi: Không tìm thấy cả tệp ngôn ngữ mặc định /etc/wptt/lang/vi.sh"
    fi
fi

# --- Gán giá trị mặc định cho các biến (quan trọng nếu file lang thiếu) ---
# **Đã đổi tên và nội dung biến**
quan_ly_start_service=${quan_ly_start_service:-"Quản lý Khởi động Service"} # Đổi tên biến và văn bản
khoi_dong_litespeed_webserver=${khoi_dong_litespeed_webserver:-"Khởi động LiteSpeed-Webserver"} # Đổi văn bản
khoi_dong_maria_database=${khoi_dong_maria_database:-"Khởi động Maria-Database"} # Đổi văn bản
khoi_dong_fail2ban=${khoi_dong_fail2ban:-"Khởi động Fail2ban"} # Đổi văn bản
khoi_dong_all_service=${khoi_dong_all_service:-"Khởi động ALL-service"} # Đổi văn bản
# khoi_dong_lai_may_chu đã bị xóa
khoi_dong_lsmemcached=${khoi_dong_lsmemcached:-"Khởi động LSMemcached"} # Đổi văn bản
khoi_dong_redis=${khoi_dong_redis:-"Khởi động Redis"} # Đổi văn bản
khoi_dong_memcached=${khoi_dong_memcached:-"Khởi động Memcached"} # Đổi văn bản
khoi_dong_csf=${khoi_dong_csf:-"Khởi động CSF"} # Đổi văn bản
khoi_dong_nftables=${khoi_dong_nftables:-"Khởi động Nftables"} # Đổi văn bản
khoi_dong_firewalld=${khoi_dong_firewalld:-"Khởi động Firewalld"} # Đổi văn bản

tinh_trang_hoat_dong_cac_service_hien_tai=${tinh_trang_hoat_dong_cac_service_hien_tai:-"Tình trạng hoạt động các service hiện tại"}
nhap_lua_chon_cua_ban=${nhap_lua_chon_cua_ban:-"Nhập lựa chọn của bạn"}
chon_nhanh=${chon_nhanh:-"Chọn nhanh"}
exit_thoat=${exit_thoat:-"Thoát"}
lua_chon_khong_hop_le=${lua_chon_khong_hop_le:-"Lựa chọn không hợp lệ"}
vui_long_chon_lai=${vui_long_chon_lai:-"Vui lòng chọn lại"}
#-----------------------------------------------------

# Hàm get_status đơn giản hóa việc lấy trạng thái
get_status() {
    local service_name=$1
    # Kiểm tra systemctl tồn tại
    if ! command -v systemctl &>/dev/null; then
        echo "no-systemctl"
        return
    fi
    # Lấy trạng thái
    systemctl status "${service_name}.service" 2>/dev/null | grep 'Active:' | cut -f2 -d':' | xargs | cut -f1 -d' ' | xargs || echo "not-found"
}

# --- Hiển thị header và trạng thái (nếu không có tham số) ---
if [[ $1 = "" ]];then
    if [[ -x "/etc/wptt/wptt-header-menu" ]]; then
        . /etc/wptt/wptt-header-menu
        header_menu
    else
        echo "Lỗi: Không tìm thấy /etc/wptt/wptt-header-menu"
    fi
    # In bảng trạng thái với định dạng cố định chiều rộng
    echo "+-----------------------------------------------------------------------+"
    # Sử dụng printf để căn chỉnh và đảm bảo độ dài, cắt bớt nếu quá dài
    printf "| %-69s |\n" "$tinh_trang_hoat_dong_cac_service_hien_tai"
    echo "+-----------------------------------------------------------------------+"
    printf "| %-13s : %-50.50s |\n" "LiteSpeed" "$(get_status lshttpd)" # Giữ lshttpd như gốc để hiển thị
    printf "| %-13s : %-50.50s |\n" "MariaDB" "$(get_status mariadb)"
    if [[ -f /etc/sysconfig/memcached ]];then
        printf "| %-13s : %-50.50s |\n" "Memcached" "$(get_status memcached)"
    fi
    if [[ -d /usr/local/lsmcd ]];then
        printf "| %-13s : %-50.50s |\n" "LSMemcached" "$(get_status lsmcd)"
    fi
    if [[ -f /etc/redis.conf ]];then
        printf "| %-13s : %-50.50s |\n" "Redis" "$(get_status redis)"
    fi
    printf "| %-13s : %-50.50s |\n" "SSH" "$(get_status sshd)"
    printf "| %-13s : %-50.50s |\n" "Crond" "$(get_status crond)"
    printf "| %-13s : %-50.50s |\n" "Fail2Ban" "$(get_status fail2ban)"
    if command -v csf &> /dev/null; then
        printf "| %-13s : %-50.50s |\n" "CSF (LFD)" "$(get_status lfd)"
    fi
    if systemctl list-units --full -all | grep -q 'firewalld.service'; then
        printf "| %-13s : %-50.50s |\n" "Firewalld" "$(get_status firewalld)"
    fi
    if systemctl list-units --full -all | grep -q 'nftables.service'; then
        printf "| %-13s : %-50.50s |\n" "Nftables" "$(get_status nftables)"
    fi
    echo "+-----------------------------------------------------------------------+"

else
    # Tải echo-color nếu có tham số
    if [[ -x "/etc/wptt/echo-color" ]]; then
        . /etc/wptt/echo-color
        echoDo "=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-="
    else
        echo "=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=" # Dự phòng
    fi
fi

# --- Định nghĩa Hàm Hành Động và Menu Động ---

# Hàm thực thi hành động dựa trên index (cho menu Start Service)
# Hàm này ánh xạ index dựa trên thứ tự TỐI ĐA các tùy chọn có thể có.
# **Đã cập nhật index và hành động**
run_action() {
    local index=$1
    local service_name=""
    local action_desc="" # Mô tả hành động

    # Ánh xạ index dựa trên thứ tự tối đa CÓ THỂ có
    # Thứ tự: lsws, mariadb, fail2ban, ALL, lsmcd, redis, memcached, csf, nftables, firewalld
    # **Index đã được điều chỉnh sau khi xóa Reboot Server (index 4 cũ)**
    case $index in
        0) service_name="lshttpd"; action_desc="${khoi_dong_litespeed_webserver}" ;; # Hoặc lshttpd
        1) service_name="mariadb"; action_desc="${khoi_dong_maria_database}" ;;
        2) service_name="fail2ban"; action_desc="${khoi_dong_fail2ban}" ;;
        3) action_desc="${khoi_dong_all_service}" ;; # Xử lý đặc biệt
        # Index 4 (Reboot Server) đã bị xóa
        4) service_name="lsmcd"; action_desc="${khoi_dong_lsmemcached}" ;;        # Index mới là 4
        5) service_name="redis"; action_desc="${khoi_dong_redis}" ;;            # Index mới là 5
        6) service_name="memcached"; action_desc="${khoi_dong_memcached}" ;;      # Index mới là 6
        7) action_desc="${khoi_dong_csf}" ;;                                     # Index mới là 7, Xử lý đặc biệt
        8) service_name="nftables"; action_desc="${khoi_dong_nftables}" ;;       # Index mới là 8
        9) service_name="firewalld"; action_desc="${khoi_dong_firewalld}" ;;     # Index mới là 9
        *) echo "${lua_chon_khong_hop_le:-Lựa chọn không hợp lệ}: Index $index."; return 1 ;;
    esac

    # Sử dụng action_desc đã lấy từ case hoặc biến ngôn ngữ
    echo "Đang thực hiện: ${action_desc}..."
    echo "-------------------------------------------------------------------------"

    # --- Thực thi hành động (Sử dụng systemctl start) ---
    if [[ $index -eq 3 ]]; then # Start ALL
        echo "Khởi động LiteSpeed..."
        systemctl start lshttpd.service # Hoặc lshttpd
        echo "Khởi động MariaDB..."
        systemctl start mariadb.service
        echo "Khởi động Fail2Ban..."
        systemctl start fail2ban.service

        # Khởi động các dịch vụ tùy chọn (phi firewall) nếu chúng tồn tại
        if systemctl list-units --full -all | grep -q 'lsmcd.service'; then
            echo "Khởi động LSMemcached..."
            systemctl start lsmcd.service
        fi
        if systemctl list-units --full -all | grep -q 'redis.service'; then
            echo "Khởi động Redis..."
            systemctl start redis.service
        fi
        if systemctl list-units --full -all | grep -q 'memcached.service'; then
            echo "Khởi động Memcached..."
            systemctl start memcached.service
        fi

        # Khởi động dịch vụ Firewall đang hoạt động (ưu tiên CSF > firewalld > nftables)
        # **Sử dụng lệnh start cho CSF**
        if command -v csf &> /dev/null && ! systemctl is-active lfd.service &>/dev/null; then
            echo "Khởi động CSF & LFD (nếu chưa chạy)..."
            csf -s &> /dev/null # Lệnh start CSF rules
            systemctl start lfd.service
        elif command -v csf &> /dev/null; then
             echo "CSF & LFD dường như đang chạy, để khởi động lại, dùng tùy chọn riêng."
        fi

        if systemctl is-active firewalld.service &>/dev/null; then
            echo "Firewalld dường như đang chạy, để khởi động lại, dùng tùy chọn riêng."
        elif systemctl list-units --full -all | grep -q 'firewalld.service'; then
            echo "Khởi động Firewalld..."
            systemctl start firewalld.service
        fi

        if systemctl is-active nftables.service &>/dev/null; then
             echo "Nftables dường như đang chạy, để khởi động lại, dùng tùy chọn riêng."
        elif systemctl list-units --full -all | grep -q 'nftables.service'; then
            echo "Khởi động Nftables..."
            systemctl start nftables.service
        fi

        echo "Hoàn thành khởi động các dịch vụ."

    # elif [[ $index -eq 4 ]]; then # Reboot Server - ĐÃ BỊ XÓA

    elif [[ $index -eq 7 ]]; then # Start CSF (Index mới là 7)
        # **Sử dụng lệnh start cho CSF**
        if command -v csf &> /dev/null; then
            echo "Khởi động CSF & LFD..."
            csf -s &> /dev/null # Start firewall rules
            systemctl start lfd.service # Start Login Failure Daemon
            echo "Hoàn thành khởi động CSF."
            sleep 1
            local lfd_status=$(systemctl is-active lfd.service 2>/dev/null)
            echo "Trạng thái LFD hiện tại: ${lfd_status:-Không xác định}"
        else
            echo "Lỗi: CSF dường như chưa được cài đặt."
        fi

    elif [[ -n "$service_name" ]]; then # Start dịch vụ cụ thể
        # **Sử dụng systemctl start**
        if systemctl list-units --full -all | grep -q "${service_name}.service"; then
            systemctl start "${service_name}.service"
            echo "Hoàn thành khởi động ${action_desc}."
            sleep 1
            local current_status=$(systemctl is-active "${service_name}.service" 2>/dev/null)
            echo "Trạng thái ${action_desc} hiện tại: ${current_status:-Không xác định}"
        else
             echo "Dịch vụ ${service_name} không tìm thấy." # Thông báo rõ hơn
        fi
    else
        echo "Lỗi logic: Không xác định được hành động cụ thể cho index $index."
        return 1
    fi

    echo "-------------------------------------------------------------------------"
    # read -rp "Nhấn Enter để quay lại menu..."
}


# **Đã cập nhật tiêu đề menu**
echo "${quan_ly_start_service:-Quản lý Khởi động Service}:"
# Mảng options cơ bản (sử dụng biến ngôn ngữ với fallback)
# **Đã cập nhật văn bản và loại bỏ tùy chọn Reboot Server**
options=(
    "${khoi_dong_litespeed_webserver:-Khởi động LiteSpeed-Webserver}" # Index 0
    "${khoi_dong_maria_database:-Khởi động Maria-Database}"          # Index 1
    "${khoi_dong_fail2ban:-Khởi động Fail2ban}"                      # Index 2
    "${khoi_dong_all_service:-Khởi động ALL-service}"                # Index 3
    # "${khoi_dong_lai_may_chu:-Khởi động lại máy chủ}"             # Index 4 cũ - ĐÃ BỊ XÓA
)
# Index tiềm năng tiếp theo: 4=lsmcd, 5=redis, 6=memcached, 7=csf, 8=nftables, 9=firewalld

# Thêm các tùy chọn động dựa trên sự tồn tại của dịch vụ
# **Đã cập nhật văn bản**
# Kiểm tra cẩn thận hơn sự tồn tại của dịch vụ trong systemd
if [[ -d /usr/local/lsmcd ]] && systemctl list-units --full -all | grep -q 'lsmcd.service'; then
    options+=("${khoi_dong_lsmemcached:-Khởi động LSMemcached}") # Index 4 tiềm năng
fi
if [[ -f /etc/redis.conf ]] && systemctl list-units --full -all | grep -q 'redis.service'; then
    options+=("${khoi_dong_redis:-Khởi động Redis}") # Index 5 tiềm năng
fi
if [[ -f /etc/sysconfig/memcached ]] && systemctl list-units --full -all | grep -q 'memcached.service'; then
    options+=("${khoi_dong_memcached:-Khởi động Memcached}") # Index 6 tiềm năng
fi
if command -v csf &> /dev/null; then
    options+=("${khoi_dong_csf:-Khởi động CSF}") # Index 7 tiềm năng
fi
if systemctl list-units --full -all | grep -q 'nftables.service'; then
     options+=("${khoi_dong_nftables:-Khởi động Nftables}") # Index 8 tiềm năng
fi
if systemctl list-units --full -all | grep -q 'firewalld.service'; then
     options+=("${khoi_dong_firewalld:-Khởi động Firewalld}") # Index 9 tiềm năng
fi


# --- Vòng lặp Menu Tương tác ---
fzf_installed=false
if command -v fzf &>/dev/null; then
    fzf_installed=true
fi

# Đặt PS3 dựa trên việc fzf có được cài đặt hay không
# Lưu ý: ${#options[@]} sẽ phản ánh số lượng tùy chọn thực tế được hiển thị
if $fzf_installed; then
    PS3="
$(tput setab 0)${nhap_lua_chon_cua_ban} (1-${#options[@]}) [00=${chon_nhanh}] [0=${exit_thoat}]:$(tput sgr0) "
else
    PS3="
$(tput setab 0)${nhap_lua_chon_cua_ban} (1-${#options[@]}) [0=${exit_thoat}]:$(tput sgr0) "
fi

echo ""
echo ""
# Sử dụng biến ngôn ngữ cho tiêu đề menu
echo ""

# Sử dụng select để hiển thị menu động
select opt in "${options[@]}"; do
    case $REPLY in
        0) # Thoát/Quay lại menu chính
            echo "Đang quay lại menu quản lý service..."
            # Giả sử wptt-service-main vẫn là script quản lý chính
            if [[ -f /etc/wptt/wptt-service-main ]]; then
                 . /etc/wptt/wptt-service-main 1
            else
                 echo "Lỗi: Không tìm thấy /etc/wptt/wptt-service-main"
            fi
            break # Thoát khỏi vòng lặp select của menu con này
            ;;

        00) # Gọi FZF (chỉ khi đã cài đặt)
            if $fzf_installed; then
                fzf_height=$(( ${#options[@]} + 4 ))
                [[ $fzf_height -gt 15 ]] && fzf_height=15 # Giới hạn chiều cao
                fzf_prompt="${nhap_lua_chon_cua_ban} (Mũi tên di chuyển, Enter chọn, ESC hủy): "

                # Hiển thị các tùy chọn thực tế trong FZF
                selected_opt=$(printf '%s\n' "${options[@]}" | nl -w 3 -s ': ' | fzf --prompt="$fzf_prompt" --height="$fzf_height" --border --cycle --reverse)
                fzf_exit_status=$?
                selected_opt=$(echo "$selected_opt" | sed 's/^[[:space:]]*[0-9]\+\:[[:space:]]*//')

                if [[ $fzf_exit_status -eq 0 ]] && [[ -n "$selected_opt" ]]; then
                    selected_index=-1
                    # Tìm index dựa trên TEXT của tùy chọn đã chọn trong mảng options HIỆN TẠI
                    for i in "${!options[@]}"; do
                        # So sánh chính xác, bỏ khoảng trắng cuối dòng
                        if [[ "$(echo -n "${options[$i]}" | sed 's/[[:space:]]*$//')" == "$(echo -n "$selected_opt" | sed 's/[[:space:]]*$//')" ]]; then
                            selected_index=$i
                            break
                        fi
                    done

                    if [[ $selected_index -ne -1 ]]; then
                        # echo "Đã chọn (FZF): ${options[$selected_index]}"
                        # Xác định index "cố định" tương ứng với lựa chọn động
                        # **Logic ánh xạ đã được cập nhật để phản ánh index mới và văn bản mới**
                        fixed_index=-1
                        option_text_selected="${options[$selected_index]}"
                        # Sử dụng văn bản mới "Khởi động" hoặc tên dịch vụ để khớp
                        if [[ "$option_text_selected" == *LiteSpeed* ]]; then fixed_index=0
                        elif [[ "$option_text_selected" == *Maria* ]]; then fixed_index=1
                        elif [[ "$option_text_selected" == *Fail2ban* ]]; then fixed_index=2
                        elif [[ "$option_text_selected" == *ALL-service* ]]; then fixed_index=3
                        # elif [[ "$option_text_selected" == *máy*chủ* ]]; then fixed_index=4 # Đã xóa
                        elif [[ "$option_text_selected" == *LSMemcached* ]]; then fixed_index=4 # Index mới
                        elif [[ "$option_text_selected" == *Redis* ]]; then fixed_index=5       # Index mới
                        elif [[ "$option_text_selected" == *Memcached* && "$option_text_selected" != *LSMemcached* ]]; then fixed_index=6 # Index mới, tránh trùng LSMemcached
                        elif [[ "$option_text_selected" == *CSF* ]]; then fixed_index=7         # Index mới
                        elif [[ "$option_text_selected" == *Nftables* ]]; then fixed_index=8     # Index mới
                        elif [[ "$option_text_selected" == *Firewalld* ]]; then fixed_index=9    # Index mới
                        fi

                        if [[ $fixed_index -ne -1 ]]; then
                            run_action "$fixed_index" # Gọi run_action với index cố định
                        else
                            echo "Lỗi: Không thể ánh xạ lựa chọn động '$option_text_selected' sang index cố định."
                        fi
                    else
                        echo "Lỗi: Không thể khớp lựa chọn FZF '$selected_opt' với danh sách."
                    fi
                else
                     # User pressed ESC or selection was empty
                     echo "${vui_long_chon_lai}"
                fi
            else
                 echo "${lua_chon_khong_hop_le}: '00'. FZF chưa được cài đặt."
            fi
            REPLY="" # Xóa REPLY để không bị xử lý ở vòng lặp sau
            # Hiển thị lại prompt PS3
            echo "$PS3"
            continue # Bỏ qua phần còn lại của vòng lặp và hiển thị lại menu
            ;;

        *) # Xử lý nhập số hoặc nhập không hợp lệ
            # Kiểm tra số nhập vào với số lượng tùy chọn THỰC TẾ được hiển thị
            if [[ "$REPLY" =~ ^[1-9][0-9]*$ ]] && [ "$REPLY" -ge 1 ] && [ "$REPLY" -le ${#options[@]} ]; then
                # Lấy index 0-based từ số người dùng nhập (1-based)
                action_index_dynamic=$((REPLY - 1))
                # echo "Đã chọn (Số): ${options[$action_index_dynamic]}"

                # Tương tự FZF, cần ánh xạ index động sang index cố định
                # **Logic ánh xạ đã được cập nhật**
                fixed_index=-1
                option_text_selected="${options[$action_index_dynamic]}"
                 if [[ "$option_text_selected" == *LiteSpeed* ]]; then fixed_index=0
                 elif [[ "$option_text_selected" == *Maria* ]]; then fixed_index=1
                 elif [[ "$option_text_selected" == *Fail2ban* ]]; then fixed_index=2
                 elif [[ "$option_text_selected" == *ALL-service* ]]; then fixed_index=3
                 # elif [[ "$option_text_selected" == *máy*chủ* ]]; then fixed_index=4 # Đã xóa
                 elif [[ "$option_text_selected" == *LSMemcached* ]]; then fixed_index=4 # Index mới
                 elif [[ "$option_text_selected" == *Redis* ]]; then fixed_index=5       # Index mới
                 elif [[ "$option_text_selected" == *Memcached* && "$option_text_selected" != *LSMemcached* ]]; then fixed_index=6 # Index mới
                 elif [[ "$option_text_selected" == *CSF* ]]; then fixed_index=7         # Index mới
                 elif [[ "$option_text_selected" == *Nftables* ]]; then fixed_index=8     # Index mới
                 elif [[ "$option_text_selected" == *Firewalld* ]]; then fixed_index=9    # Index mới
                 fi

                 if [[ $fixed_index -ne -1 ]]; then
                     run_action "$fixed_index" # Gọi run_action với index cố định
                 else
                     echo "Lỗi: Không thể ánh xạ lựa chọn động '$option_text_selected' sang index cố định."
                 fi
            else
                echo "${lua_chon_khong_hop_le}: '$REPLY'. ${vui_long_chon_lai}"
            fi
            REPLY="" # Xóa REPLY
            # Hiển thị lại prompt PS3
            echo "$PS3"
            continue # Bỏ qua phần còn lại của vòng lặp và hiển thị lại menu
            ;;
    esac
    # Chỉ break nếu người dùng chọn 0 (Thoát)
done

# Script kết thúc sau khi break khỏi vòng lặp
