#!/bin/bash

. /etc/wptt/.wptt.conf
if [[ $ngon_ngu = '' ]];then
	ngon_ngu='vi'
fi
. /etc/wptt/lang/$ngon_ngu.sh

. /etc/wptt/tenmien
echo ""
echo ""
echo "Lựa chọn muốn proxy nguồn: "
echo ""
lua_chon_NAME

if [[ $(cat /usr/local/lsws/conf/vhosts/$NAME/$NAME.conf | grep 'proxy') ]];then
	echo "Đã setup proxy ngược trước đó rồi"
	echo "Tiến hành xoá setup proxy ngược"
sed -i -e '/^context \/ {/,/^}$/d' /usr/local/lsws/conf/vhosts/$NAME/$NAME.conf
sed -i -e '/^context \/.well-known\/acme-challenge {/,/^}$/d' /usr/local/lsws/conf/vhosts/$NAME/$NAME.conf
sed -i -e '/^extprocessor '$NAME'proxy {/,/^}$/d' /usr/local/lsws/conf/vhosts/$NAME/$NAME.conf
/usr/local/lsws/bin/lswsctrl restart >/dev/null 2>&1
echo "Hoàn tất xoá proxy ngược"
exit;
fi

read -p 'Nhập ip muốn proxy nguồn: ' ip

echo "
extprocessor ${NAME}proxy {
  type                    proxy
  address                 $ip:80
  maxConns                2000
  initTimeout             90
  retryTimeout            20
  respBuffer              0
}

" >> /usr/local/lsws/conf/httpd_config.conf

sed -i -e '/^context/,/^}$/d' /usr/local/lsws/conf/vhosts/$NAME/$NAME.conf

echo "
context / {
  type                    proxy
  handler                 ${NAME}proxy
  addDefaultCharset	  off
}

context /.well-known/acme-challenge {
  location                /usr/local/lsws/Example/html/.well-known/acme-challenge
  allowBrowse             1

  rewrite  {
     enable                  0
  }
  addDefaultCharset       off

  phpIniOverride  {

  }
}
" >> /usr/local/lsws/conf/vhosts/$NAME/$NAME.conf

/usr/local/lsws/bin/lswsctrl restart >/dev/null 2>&1

echo "Hoàn tất thiết lập proxy website $NAME về $ip"
echo "Sử dụng tính năng này hãy sử dụng kèm với tính năng cài ssl cloudflare api"
