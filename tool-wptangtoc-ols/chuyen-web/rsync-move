#!/bin/bash


read -p "Nhập địa chỉ IP server mới: " IP
read -p "Nhập Port SSH Server mới: " Port

. /etc/wptt/.wptt.conf

if [ "$(ls -A /etc/wptt/vhost)" ]; then
	echo
	rm -f /usr/local/lsws/$Website_chinh/html/danh-sach-website-wptangtoc-ols.txt
	echo '--------------------------------------------------'
	for entry in $(ls -A /etc/wptt/vhost); do
		domain=$(echo $entry | sed 's/^.//' | sed 's/.conf//')
		path="/usr/local/lsws/$domain/html"
		i=1
		if [[ -d "$path" ]]; then
			mysqldump -u $(cat $path/wp-config.php | grep DB_USER | cut -d \' -f4) -p"$(cat $path/wp-config.php | grep DB_PASSWORD | cut -d \' -f4)" $(cat $path/wp-config.php | grep DB_NAME | cut -d \' -f4) --single-transaction --quick --lock-tables=false >$path/giatuan-wptangtoc.sql
			database="$path/giatuan-wptangtoc.sql"
			check_file_error=$(du -c $database | awk '{print $1}' | sed '1d')
			if (( $check_file_error < 10 )); then
				echo "Qua trinh bi loi không sao lưu được db website $NAME"
			else
				echo "Hoan tat sao luu database $domain"
				echo "$domain" >> /usr/local/lsws/$Website_chinh/html/danh-sach-website-wptangtoc-ols.txt
			fi
		fi
	done
	echo '--------------------------------------------------'
	echo
fi

if [ "$(ls -A /etc/wptt/vhost)" ]; then

rm -f /tmp/domain-rsync-move
for entry in $(ls -A /etc/wptt/vhost); do
domain=$(echo $entry | sed 's/^.//' | sed 's/.conf//')
path="/usr/local/lsws/$domain/html"
i=1
if [[ -d "$path" ]]; then
echo "/usr/local/lsws/$domain" >> /tmp/domain-rsync-move
fi
done
fi

list_ssl_domain_all=$(cat /tmp/domain-rsync-move | sort -u |uniq |sed '/^$/d' | sed 's/ $//g' | tr -s '\n' ' ')
if [[ $(which rsync) = '' ]];then
yum install rsync -y
fi

echo "Lệnh: rsync -avzh -e 'ssh -p $Port' $list_ssl_domain_all root@$IP:/usr/local/lsws"
rsync -avzh -e 'ssh -p $Port' $list_ssl_domain_all root@$IP:/usr/local/lsws
echo "Hoàn tất server mới hãy gõ lệnh: curl -sO https://wptangtoc.com/share/wptt-rsync-move && bash wptt-rsync-move"
