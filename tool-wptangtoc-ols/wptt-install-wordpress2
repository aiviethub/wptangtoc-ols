#!/bin/bash
function huong_dan() {
  T√≠nh nƒÉng c√†i ƒë·∫∑t m√£ ngu·ªìn WordPress, th√¨ ƒë√¢y l√† m·ªôt ch·ª©c nƒÉng t·ª± ƒë·ªông h√≥a m·∫°nh m·∫Ω, gi√∫p b·∫°n tri·ªÉn khai m·ªôt website WordPress ho√†n to√†n m·ªõi l√™n m√°y ch·ªß m·ªôt c√°ch nhanh ch√≥ng v√† d·ªÖ d√†ng.

  T√≠nh nƒÉng C√†i ƒë·∫∑t M√£ ngu·ªìn WordPress [WPTangToc OLS]
  üöÄ M·ª•c ƒë√≠ch ch√≠nh:
  * Ti·∫øt ki·ªám Th·ªùi gian &
  C√¥ng s·ª©c: Thay v√¨ ph·∫£i th·ª±c hi·ªán h√†ng lo·∫°t b∆∞·ªõc th·ªß c√¥ng [t·∫°o database, t·∫£i WordPress, c·∫•u h√¨nh wp-config.php, ch·∫°y c√†i ƒë·∫∑t], t√≠nh nƒÉng n√†y s·∫Ω l√†m t·∫•t c·∫£ ch·ªâ b·∫±ng m·ªôt v√†i thao t√°c ho·∫∑c m·ªôt l·ªánh.
  * Chu·∫©n h√≥a C√†i ƒë·∫∑t: ƒê·∫£m b·∫£o c√°c website m·ªõi ƒë∆∞·ª£c c√†i ƒë·∫∑t theo m·ªôt c·∫•u tr√∫c v√† c·∫•u h√¨nh chu·∫©n, c√≥ th·ªÉ ƒë√£ ƒë∆∞·ª£c t·ªëi ∆∞u s·∫µn cho m√¥i tr∆∞·ªùng OpenLiteSpeed v√† c√°c t√≠nh nƒÉng kh√°c c·ªßa WPTangToc OLS.
  * Gi·∫£m thi·ªÉu L·ªói: T·ª± ƒë·ªông h√≥a gi√∫p h·∫°n ch·∫ø t·ªëi ƒëa c√°c sai s√≥t c√≥ th·ªÉ x·∫£y ra khi th·ª±c hi·ªán th·ªß c√¥ng.
  * Th√¢n thi·ªán v·ªõi Ng∆∞·ªùi d√πng: Gi√∫p c·∫£ nh·ªØng ng∆∞·ªùi kh√¥ng qu√° r√†nh v·ªÅ k·ªπ thu·∫≠t c≈©ng c√≥ th·ªÉ d·ªÖ d√†ng t·∫°o m·ªôt website WordPress m·ªõi.

  ‚úÖ L·ª£i √≠ch:
  * Tri·ªÉn khai Nhanh: T·∫°o website m·ªõi ch·ªâ trong v√†i ph√∫t.
  * D·ªÖ d√†ng &
  Ti·ªán l·ª£i: Quy tr√¨nh ƒë∆°n gi·∫£n h√≥a.
  * T·ªëi ∆∞u S·∫µn: Website m·ªõi c√≥ kh·∫£ nƒÉng ƒë∆∞·ª£c c√†i ƒë·∫∑t v·ªõi c√°c thi·∫øt l·∫≠p t·ªëi ∆∞u cho OLS.
  T√≥m l·∫°i: T√≠nh nƒÉng c√†i ƒë·∫∑t m√£ ngu·ªìn WordPress trong WPTangToc OLS l√† m·ªôt c√¥ng c·ª• t·ª± ƒë·ªông h√≥a gi√∫p ƒë∆°n gi·∫£n h√≥a v√† tƒÉng t·ªëc qu√° tr√¨nh t·∫°o m·ªôt website WordPress m·ªõi tr√™n m√°y ch·ªß OpenLiteSpeed, ƒë·ªìng th·ªùi ƒë·∫£m b·∫£o website ƒë∆∞·ª£c thi·∫øt l·∫≠p theo c√°c ti√™u chu·∫©n c√≥ th·ªÉ ƒë√£ ƒë∆∞·ª£c t·ªëi ∆∞u h√≥a b·ªüi b·ªô c√¥ng c·ª• n√†y.
}

export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8
stty iutf8 #t·ª´ latin1 sang utf8, nhi·ªÅu khi anh em d√πng b·ªô g√µ ti·∫øng vi·ªát: d√πng √† √¢ n√≥ th√™m \xc3 hay \xa9 ... t∆∞∆°ng th√≠ch v·ªõi b·ªô g√µ ti·∫øng vi·ªát telex khi nh·∫≠p domain

. /etc/wptt/.wptt.conf
if [[ $ngon_ngu = '' ]]; then
  ngon_ngu='vi'
fi
. /etc/wptt/lang/$ngon_ngu.sh

echo "========================================================================="
. /etc/wptt/tenmien
echo ""
echo ""
echo "$lua_chon_website_ban_muon $thiet_lap WordPress:"
echo ""
lua_chon_NAME
domain="$NAME"

if [[ "$NAME" = "0" || "$NAME" = "" ]]; then
  check_menu_wptangtoc_active=$1
  if [[ $check_menu_wptangtoc_active = "99" ]]; then
    wptangtoc 1
  fi

  if [[ $check_menu_wptangtoc_active = "98" ]]; then
    . /etc/wptt/wptt-wordpress-main 1
  fi
  return 2>/dev/null
  exit
fi

pathcheck="/etc/wptt/vhost/.$NAME.conf"
if [[ ! -f "$pathcheck" ]]; then
  clear
  echoDo "$ten_mien_nay_khong_ton_tai_tren_he_thong"
  sleep 3
  wptangtoc 1
  exit
fi

. /etc/wptt/vhost/."$NAME".conf
. /etc/wptt/.wptt.conf

. /etc/wptt/echo-color

if [[ -f /usr/local/lsws/$NAME/html/wp-load.php ]]; then
  echo "$dieu_nay_se_xoa_toan_bo_wordpress_hien_tai_hoan_toan"
fi

echo "$xac_nhan $thiet_lap Wordpress $phien_ban $moi_nhat cho domain $domain"
prompt="$nhap_lua_chon_cua_ban [1-2]: "
dongy_1="n"
options=("$dong_y" "$khong_dong_y")
PS3="$prompt"
select opt in "${options[@]}"; do
  case "$REPLY" in
  1)
    dongy_1="y"
    break
    ;;

  2)
    dongy_1="n"
    break
    ;;

  $((${#options[@]} + 1)))
    printf "\nB·∫°n nh·∫≠p sai h·ªá th·ªëng s·∫Ω ch·ªçn l√† kh√¥ng ƒë·ªìng √Ω\n"
    break
    ;;
  *)
    printf "B·∫°n nh·∫≠p sai h·ªá th·ªëng s·∫Ω ch·ªçn l√† kh√¥ng ƒë·ªìng √Ω\n"
    break
    ;;
  esac
done

if [[ "$dongy_1" = "y" ]]; then
  echo "Install m√£ ngu·ªìn Wordpress website $NAME : $(date '+%d-%m-%Y %H:%M')" >>/var/log/wptangtoc-ols.log
  if [[ $lock_down ]]; then
    _runing "$tat lock down website $NAME"
    . /etc/wptt/bao-mat/wptt-chattr-file-lock $NAME off
    sed -i '/lock_down/d' /etc/wptt/vhost/.$NAME.conf
    _rundone "$tat lock down website $NAME"
  fi

  _runing "$lam_sach_toan_bo_du_lieu_ma_nguon_cua $NAME"
  cd /usr/local/lsws/"$NAME"/html/

  rm -rf /usr/local/lsws/"$NAME"/html/*

  if [[ -d /usr/local/lsws/"$NAME"/luucache ]]; then
    rm -rf /usr/local/lsws/"$NAME"/luucache
  fi

  _rundone "$lam_sach_toan_bo_du_lieu_ma_nguon_cua $NAME"

  _runing "$tai $ma_nguon WordPress"

  wget -q https://wordpress.org/latest.tar.gz #download b·∫±ng https
  if [[ ! -f latest.tar.gz ]]; then
    wget -q http://wordpress.org/latest.tar.gz #download d·ª± ph√≤ng b·∫±ng http
  fi

  if [[ ! -f latest.tar.gz ]]; then
    _runloi "$tai $ma_nguon WordPress"
    echoDo "Ch∆∞a th·ªÉ download m√£ ngu·ªìn WordPress vui l√≤ng th·ª≠ l·∫°i sau"
    check_menu_wptangtoc_active=$1
    if [[ $check_menu_wptangtoc_active = "99" ]]; then
      wptangtoc 1
    fi
    return 2>/dev/null
    exit
  fi

  _rundone "$tai $ma_nguon WordPress"
  _runing "$giai_nen $ma_nguon WordPress"
  tar -zxf latest.tar.gz
  mv wordpress/* /usr/local/lsws/"$NAME"/html && rm -rf wordpress && rm -f latest.tar.gz
  _rundone "$giai_nen $ma_nguon WordPress"

  . /etc/wptt/ssl/check-ssl-cert-con-kha-dung $NAME #check ssl kh·∫£ d·ª•ng
  if [[ $ssl_xac_thuc_kha_dung = 'true' ]]; then
    ssl_check="https://"
  else
    ssl_check="http://"
  fi

  if [[ "$DB_Name_web" != "" ]]; then
    _runing "$lam_sach_toan_bo_du_lieu_database $NAME"
    database1="$DB_Name_web"
    mariadb -u $database_admin_username -p"$database_admin_password" -e "DROP DATABASE $DB_Name_web"
    mariadb -u $database_admin_username -p"$database_admin_password" -e "CREATE DATABASE IF NOT EXISTS $DB_Name_web"
    _rundone "$lam_sach_toan_bo_du_lieu_database $NAME"

    echo "$xac_nhan $ban_co_muon $thiet_lap $cai_dat WordPress $ngay_tai_day_khong: "
    prompt="$nhap_lua_chon_cua_ban [1-2]: "
    bien=$1
    dongyconfig="n"
    options=("$dong_y" "$khong_dong_y")
    PS3="$prompt"
    select opt in "${options[@]}"; do
      case "$REPLY" in
      1)
        dongyconfig="y"
        break
        ;;

      2)
        dongyconfig="n"
        break
        ;;

      $((${#options[@]} + 1)))
        printf "\nB·∫°n nh·∫≠p sai h·ªá th·ªëng s·∫Ω ch·ªçn l√† kh√¥ng ƒë·ªìng √Ω\n"
        break
        ;;
      *)
        printf "B·∫°n nh·∫≠p sai h·ªá th·ªëng s·∫Ω ch·ªçn l√† kh√¥ng ƒë·ªìng √Ω\n"
        break
        ;;
      esac

    done

    if [[ ! -f /usr/local/bin/wp ]]; then
      curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
      chmod +x wp-cli.phar
      mv wp-cli.phar /usr/local/bin/wp
    fi

    tien_to_db=$(
      date +%s | sha256sum | base64 | head -c 6
      echo
    )
    wp core config --dbname="$DB_Name_web" --dbuser="$DB_User_web" --dbpass="$DB_Password_web" --dbhost=localhost --dbprefix="${tien_to_db}"_ --dbcharset='utf8mb4' --dbcollate='utf8mb4_unicode_ci' --allow-root --extra-php >/dev/null 2>&1 <<PHP
define( 'WP_DEBUG_LOG', false );
define( 'WP_DEBUG_DISPLAY', false );
PHP

    mkdir -p /usr/local/lsws/"$NAME"/passwd
    Post_Install_Regenerate_Webadmin_Console_Passwd() {
      if [[ "$Server_Edition" = "OLS" ]]; then
        PHP_Command="admin_php"
      else
        PHP_Command="admin_php5"
      fi

      Webadmin_Pass=$(
        head /dev/urandom | tr -dc A-Za-z0-9 | head -c 12
        echo ''
      )
      id_ols_admin=$(
        date +%s | sha256sum | base64 | head -c 12
        echo
      )
      Encrypt_string=$(/usr/local/lsws/admin/fcgi-bin/admin_php -q /usr/local/lsws/admin/misc/htpasswd.php "${Webadmin_Pass}")
      echo "" >/usr/local/lsws/"$NAME"/passwd/.mk-setup
      echo "$id_ols_admin:$Encrypt_string" >/usr/local/lsws/"$NAME"/passwd/.mk-setup
    }
    Post_Install_Regenerate_Webadmin_Console_Passwd

    sed -i -e '/^realm '${NAME}wordpress-setup'/,/^}$/d' /usr/local/lsws/conf/vhosts/"$NAME"/"$NAME".conf
    sed -i -e '/^context exp:wp-admin\/install.php/,/^}$/d' /usr/local/lsws/conf/vhosts/"$NAME"/"$NAME".conf

    echo 'realm '${NAME}wordpress-setup' {

  userDB  {
    location              /usr/local/lsws/'$NAME'/passwd/.mk-setup
  }
}

context exp:wp-admin/install.php {
  location                $DOC_ROOT/$0
  allowBrowse             1
  realm                   '${NAME}wordpress-setup'

  accessControl  {
    allow                 ALL
  }

  rewrite  {

  }
  addDefaultCharset	  off

  phpIniOverride  {

  }
}' >>/usr/local/lsws/conf/vhosts/"$NAME"/"$NAME".conf

    if [[ "$dongyconfig" = "y" ]]; then
      read -p "1. $ten_tieu_de_website_wordpress_cua_ban_muon: " SiteTitle
      read -p "2. $nhap_id_dang_nhap_wordpress: " idusername
      # read -sp "3. $nhap_password_wordpress:
      # $luu_y_nhap_wordpress_it_nhat_12_ky_tu: " mypassword

      mypassword=""
      print_nhap_password="3. $nhap_password_wordpress:
$luu_y_nhap_wordpress_it_nhat_12_ky_tu: "
      echo -n "$print_nhap_password"

      while IFS= read -r -s -N 1 char; do

        # Ki·ªÉm tra Enter (k√Ω t·ª± r·ªóng HO·∫∂C k√Ω t·ª± xu·ªëng d√≤ng '\n' HO·∫∂C k√Ω t·ª± v·ªÅ ƒë·∫ßu d√≤ng '\r')
        if [[ -z "$char" ]] || [[ "$char" == $'\n' ]] || [[ "$char" == $'\r' ]]; then
          echo                              # Xu·ªëng d√≤ng sau khi nh·∫≠p xong
          break                             # Tho√°t v√≤ng l·∫∑p
        elif [[ "$char" == $'\x7f' ]]; then # Ki·ªÉm tra Backspace
          if [[ -n "$mypassword" ]]; then
            mypassword="${mypassword%?}"
            echo -ne '\b \b'
          fi
        else # K√Ω t·ª± b√¨nh th∆∞·ªùng
          mypassword+="$char"
          echo -n '*'
        fi

      done

      if [[ $mypassword = "" ]]; then
        echo "$nhap_password_wordpress - $ban_chua_nhap_password"
        print_nhap_password="3. $nhap_password_wordpress:
$luu_y_nhap_wordpress_it_nhat_12_ky_tu: "
        echo -n "$print_nhap_password"

        while IFS= read -r -s -N 1 char; do

          # Ki·ªÉm tra Enter (k√Ω t·ª± r·ªóng HO·∫∂C k√Ω t·ª± xu·ªëng d√≤ng '\n' HO·∫∂C k√Ω t·ª± v·ªÅ ƒë·∫ßu d√≤ng '\r')
          if [[ -z "$char" ]] || [[ "$char" == $'\n' ]] || [[ "$char" == $'\r' ]]; then
            echo                              # Xu·ªëng d√≤ng sau khi nh·∫≠p xong
            break                             # Tho√°t v√≤ng l·∫∑p
          elif [[ "$char" == $'\x7f' ]]; then # Ki·ªÉm tra Backspace
            if [[ -n "$mypassword" ]]; then
              mypassword="${mypassword%?}"
              echo -ne '\b \b'
            fi
          else # K√Ω t·ª± b√¨nh th∆∞·ªùng
            mypassword+="$char"
            echo -n '*'
          fi

        done

      fi

      echo ""
      read -p "4. $nhap Email website $domain
v√≠ d·ª• abc@gmail.com, giatuan@wptangtoc.com: " emailwp
      while [ "$emailwp" = "${emailwp/@/}" ]; do
        clear
        . /etc/wptt/echo-color
        echoDo "$email_khong_dung_dinh_dang"
        echo "Vui loÃÄng nh√¢Ã£p laÃ£i ƒëiÃ£a chiÃâ email"
        read -p "4. $nhap Email website $domain
v√≠ d·ª• abc@gmail.com, giatuan@wptangtoc.com: " emailwp
      done

      _runing "$thiet_lap WordPress"
      wp core install --url="${ssl_check}""${domain}" --title="$SiteTitle" --admin_user="$idusername" --admin_password="$mypassword" --admin_email="$emailwp" --allow-root >/dev/null 2>&1
      unset mypassword
    fi
  fi

  echo '
# BEGIN WordPress
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]
RewriteBase /
RewriteRule ^index\.php$ - [L]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule . /index.php [L]
</IfModule>
# END WordPress' >/usr/local/lsws/"$domain"/html/.htaccess

  if [[ "$dongyconfig" = "y" ]]; then
    wp language core install vi --path=/usr/local/lsws/"$NAME"/html --activate --allow-root >/dev/null 2>&1
    wp option update timezone_string "Asia/Ho_Chi_Minh" --path=/usr/local/lsws/"$NAME"/html --allow-root >/dev/null 2>&1
    wp rewrite structure '/%postname%/' --path=/usr/local/lsws/"$NAME"/html --allow-root >/dev/null 2>&1

    #delete b·∫£o m·∫≠t login thi·∫øt l·∫≠p wp-admin/install.php
    sed -i -e '/^realm '${NAME}wordpress-setup'/,/^}$/d' /usr/local/lsws/conf/vhosts/"$NAME"/"$NAME".conf
    sed -i -e '/^context exp:wp-admin\/install.php/,/^}$/d' /usr/local/lsws/conf/vhosts/"$NAME"/"$NAME".conf
    rm -f /usr/local/lsws/"$NAME"/passwd/.mk-setup

    _rundone "$thiet_lap WordPress"
  fi

  #tao file robots
  cat >"/usr/local/lsws/$NAME/html/robots.txt" <<END
User-agent: *
Disallow: /wp-admin/
Allow: /wp-admin/admin-ajax.php
END

  _runing "$phan_quyen website $NAME"
  chown -R "$User_name_vhost":"$User_name_vhost" /usr/local/lsws/"$domain"/html

  /usr/local/lsws/bin/lswsctrl restart >/dev/null 2>&1
  _rundone "$phan_quyen website $NAME"

  clear
  blue='\033[1;34m'
  NC='\033[0m'
  echo -e "${blue}               ...:..........:...              
           .:..      ....      ..:.           
        .:.   .::------------::.   .:.        
      ::.  .:---------------------:  .::      
    .:.  :------------------------.    .:.    
   ::  :-------------------------        ::   
  ::       . .--:.        . :----         ::  
 ::        :-------:      -------:      .  :: 
 -  -:      --------:      --------     :-  - 
:. .--.     .--------.     .-------:    --. .:
-  :---      :--------      --------.  .--:  -
-  :----      --------       -------   ---:  -
-  :----:     .------. .     .------  ----:  -
:. .-----.     :----- .-      -----. :----. .:
 -  :-----      ----  ---      ---: .----:  - 
 ::  -----:     .--. ----:     .--  -----  :: 
  ::  -----:     :- .-----.     -. :----  ::  
   ::  :----.       -------       .---:  ::   
    .:.  :---      --------:      --:  .:.    
      ::.  .-:    :---------:    :.  .::      
        .:.       -----------      .:.        
           .:...     ....     ...:.           
              ...:..........:...     ${NC}"
  echo "-------------------------------------------------------------------------"
  echo "$cai_dat_thanh_cong."
  echo "-------------------------------------------------------------------------"
  echo -e "Domain \t\t\t: ${ssl_check}${domain}"
  echo -e "$duong_dan_thu_muc\t: /usr/local/lsws/$domain/html/"
  echo "-------------------------------------------------------------------------"
  if [[ "$dongyconfig" = "y" ]]; then
    echo "$thong_tin WordPress domain $domain"
    echo "$ten_tieu_de_website_wordpress_cua_ban		: $SiteTitle "
    echo "URL WordPress Admin	: ${ssl_check}${domain}/wp-admin/"
    echo "$id_dang_nhap_wp			: $idusername "
    echo "Password Wordpress			: ****************** "
    echo "Email website			: $emailwp "
    echo "-------------------------------------------------------------------------"
  else
    echo -e "Username ƒëƒÉng nh·∫≠p WordPress thi·∫øt l·∫≠p \t: $id_ols_admin"
    echo -e "PassWord ƒëƒÉng nh·∫≠p WordPress thi·∫øt l·∫≠p \t: $Webadmin_Pass"

    phut='3'
    cat >"/etc/cron.d/wp-delete-setup-bao-mat-$NAME.cron" <<END
*/$phut * * * * root /bin/bash /etc/wptt/wordpress/delete-auth-setup-wordpress-config $NAME >/dev/null 2>&1
END

    if $(cat /etc/*release | grep -q "Ubuntu"); then
      NAME_CRON_ubuntu=${NAME//[.]/_}
      ln -sf /etc/cron.d/wp-delete-setup-bao-mat-$NAME.cron /etc/cron.d/wp-delete-setup-bao-mat-${NAME_CRON_ubuntu}_cron
      systemctl restart cron.service
    else
      systemctl restart crond.service
    fi

  fi
  echo

fi

check_menu_wptangtoc_active=$1
if [[ $check_menu_wptangtoc_active = "99" ]]; then
  wptangtoc 1
fi

if [[ $check_menu_wptangtoc_active = "98" ]]; then
  . /etc/wptt/wptt-wordpress-main 1
fi
