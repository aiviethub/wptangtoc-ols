#!/bin/bash

# ==============================================================================
# Dựa trên Hệ điều hành và Kiến trúc CPU được phát hiện tự động.
# ==============================================================================

# --- Tự động phát hiện thông tin hệ thống ---

# Lấy thông tin hệ điều hành và phiên bản từ file /etc/os-release
if [ -f /etc/os-release ]; then
  # Dùng source (dấu .) để nạp các biến từ file vào script
  . /etc/os-release
else
  echo "Lỗi: Không thể xác định hệ điều hành vì tệp /etc/os-release không tồn tại."
  exit 1
fi

# Lấy kiến trúc CPU (ví dụ: x86_64, aarch64)
ARCH=$(uname -m)

# --- Khai báo biến ---
BASE_URL="https://rpms.litespeedtech.com"
REPO_PATH="" # Đường dẫn sẽ được xác định bên dưới

# --- Logic IF/ELSE để xác định đường dẫn kho lưu trữ ---

# Kiểm tra nếu là hệ điều hành dựa trên Enterprise Linux
# Bao gồm: AlmaLinux, Rocky, CentOS, Red Hat Enterprise Linux, Oracle Linux
if [[ "$ID" == "almalinux" || "$ID" == "rocky" || "$ID" == "centos" || "$ID" == "rhel" || "$ID" == "ol" ]]; then
  MAJOR_VERSION=$(echo "$VERSION_ID" | cut -d. -f1)

  # Xác định kiến trúc CPU cho URL
  REPO_ARCH=""
  if [[ "$ARCH" == "x86_64" ]]; then
    REPO_ARCH="x86_64"
  elif [[ "$ARCH" == "aarch64" ]]; then
    REPO_ARCH="aarch64" # Tương đương ARM 64-bit
  else
    echo "Lỗi: Kiến trúc CPU '${ARCH}' không được hỗ trợ cho các hệ điều hành EL."
    exit 1
  fi

  # Xây dựng đường dẫn dựa trên phiên bản EL (8 hoặc 9)
  if [[ "$MAJOR_VERSION" == "8" ]]; then
    REPO_PATH="centos/8/${REPO_ARCH}/RPMS/"
  elif [[ "$MAJOR_VERSION" == "9" ]]; then
    REPO_PATH="centos/9/${REPO_ARCH}/RPMS/"
  else
    echo "Lỗi: Phiên bản EL '${MAJOR_VERSION}' không được hỗ trợ."
    exit 1
  fi

# Kiểm tra nếu là Ubuntu
elif [[ "$ID" == "ubuntu" ]]; then
  # ⚠️ Lưu ý quan trọng: Ubuntu sử dụng gói .deb, không phải .rpm.
  # Script sẽ trỏ đến kho lưu trữ "debian" của LiteSpeed, nơi chứa các gói .deb.
  CODENAME_PHIEN_BAN=$(cat /etc/os-release | grep UBUNTU_CODENAME | cut -f2 -d=)
  if [[ -n "$CODENAME_PHIEN_BAN" ]]; then
    # Cấu trúc thư mục của họ không phân chia theo CPU ở cấp cao nhất
    REPO_PATH="debian/pool/main/${CODENAME_PHIEN_BAN}/"
  else
    echo "Lỗi: Không thể xác định mã phiên bản (codename) của Ubuntu."
    exit 1
  fi

# Nếu không phải các hệ điều hành trên
else
  echo "Lỗi: Hệ điều hành '${ID}' không được hỗ trợ bởi script này."
  exit 1
fi

# --- Thực thi lệnh curl với URL đã được xác định ---
if [[ -n "$REPO_PATH" ]]; then
  FINAL_URL="${BASE_URL}/${REPO_PATH}"
  # Thực thi curl ở chế độ im lặng và lưu kết quả
  curl -s "${FINAL_URL}" >/tmp/php_extension_call_eol
else
  echo "Lỗi: Không thể xây dựng đường dẫn kho lưu trữ cuối cùng."
  exit 1
fi
