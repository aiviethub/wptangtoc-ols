#!/bin/bash
echo ""
echo ""
echo ""
echo "========================================================================="
echo "|Quan ly WordPress => Clear va preload plugin WP Rocket                 |"
echo "========================================================================="

. /etc/wptt/tenmien
echo ""
echo ""
echo "Lua chon website wordpress muon thay doi tien to Database: "
echo ""
lua_chon_NAME

pathcheck="/etc/wptt/vhost/.$NAME.conf"
if [[ ! -f "$pathcheck" || "$NAME" = "0" ]]; then
	clear
	. /etc/wptt/wptt-menu-wordpress
	exit
fi

pathcheckwp="/usr/local/lsws/$NAME/html/wp-load.php"
if [[ ! -f "$pathcheckwp" ]]; then
  clear
  echo "He thong xac nhan ban chua kich hoat su dung WordPress"
  sleep 3
  . /etc/wptt/wptt-menu-wordpress
  exit
fi


path_plugin_wprocket="/usr/local/lsws/$NAME/html/wp-content/plugins/wp-rocket"
if [[ ! -d "$path_plugin_wprocket" ]]; then
	echo "Ban khong su dung plugin wp rocket"
	exit
fi

html="/usr/local/lsws/$NAME/html"
path_clear_wp="${html}/rocket-clean.php"
echo "<?php 
require( 'wp-load.php' );
if ( function_exists( 'rocket_clean_domain' ) ) {
	rocket_clean_domain();
}
if ( function_exists( 'run_rocket_sitemap_preload' ) ) {
	run_rocket_sitemap_preload();
}" >"$path_clear_wp"
echo "Dang tien hanh clean cache v√† preload"
curl "http://$NAME/rocket-clean.php"
. /etc/wptt/vhost/.$NAME.conf
chown $User_name_vhost:$User_name_vhost "$path_clear_wp"
rm -f "$path_clear_wp"
echo "Hoan thanh qua trinh clear cache wp rocket va preload cache wp rocket"
