#!/bin/bash
echo ""
echo ""
echo ""
echo "========================================================================="
echo "|Quản lý WordPress => Login wp-admin magic link                         |"
echo "========================================================================="
echo ""
echo ""
NAME=$1

if [[ $NAME = "98" ]];then
NAME=""
fi

if [[ "$NAME" = "" ]];then
. /etc/wptt/tenmien
echo ""
echo ""
echo "Lựa chọn website bạn muốn login wp-admin magic link:"
echo ""
lua_chon_NAME
fi

if [[ "$NAME" = "0" || "$NAME" = "" ]]; then
    . /etc/wptt/wptt-wordpress-main 1
fi

. /etc/wptt/echo-color

pathcheck="/etc/wptt/vhost/.$NAME.conf"
if [[ ! -f "$pathcheck" ]]; then
    clear
	echoDo "Domain không tồn tại trên hệ thống này."
    sleep 3
    . /etc/wptt/wptt-wordpress-main 1
    exit
fi


pathcheckwp="/usr/local/lsws/$NAME/html/wp-load.php"
if [[ ! -f "$pathcheckwp" ]]; then
  clear
  echoDo "He thong xac nhan ban chua kich hoat su dung WordPress"
  echDo "Tính năng này chỉ dành cho mã nguồn website WordPress"
  sleep 3
  . /etc/wptt/wptt-wordpress-main 1
  exit
fi


        PACKAGEQUERY=$(wp package list --allow-root | grep -i 'wp-cli-login-command')
        if [[ $PACKAGEQUERY = "" ]];then
	wp package install aaemnnosttv/wp-cli-login-command --allow-root
        fi
        
path="/usr/local/lsws/$NAME/html"
pathlogin="/usr/local/lsws/$NAME/html/wp-content/plugins/wp-cli-login-server"

if [[ ! -d "$pathlogin" ]]; then
wp login install --activate --path=$path --allow-root 2>/dev/null
. /etc/wptt/vhost/."$NAME".conf
chown -R "$User_name_vhost":"$User_name_vhost" $pathlogin
find $pathlogin -type d -exec chmod 755 {} \;
find $pathlogin -type f -exec chmod 644 {} \;
fi
	clear
tuan=$(wp user list --role=administrator --fields=user_login --path=$path --allow-root 2>/dev/null | sed '/user_login/d' | tail -1 | sed -n '$p')
giatuandzdz=$(wp login create "$tuan" --path=$path --allow-root 2>/dev/null | grep 'http')
if [[ "$giatuandzdz" ]];then
echo "Truy cập vào đường link này để login vào wp-admin"
echo "========================================================================="
echoDone "Đường dẫn đăng nhập: $giatuandzdz"
echo "========================================================================="
echo "Khi truy cập vào link trên thì magic link sẽ tự động bị vô hiệu hóa"
else
echoDo "Đã có lỗi xảy ra"
echoDo "Không thiết lập được magic link login"
fi

check_menu_wptangtoc_active=$1
if [[ $check_menu_wptangtoc_active = "98" ]];then
. /etc/wptt/wptt-wordpress-main 1
fi

