#!/bin/bash
#
#
# @author: Gia Tuấn
# @website: https://wptangtoc.com
# @since: 2021
echo ""
echo ""
echo ""
echo "========================================================================="
echo "|Quản lý SSL => Kiểm tra chứng chỉSSL                                   |"
echo "========================================================================="
. /etc/wptt/tenmien
echo ""
echo ""
echo "Lựa chọn website bạn muốn kiếm tra chứng chỉ SSL (HTTPS):"
echo ""
lua_chon_NAME

. /etc/wptt/echo-color
path="/etc/wptt/vhost/.$NAME.conf"
if [[ ! -f "$path" || "$NAME" = "0" ]]; then
    clear
	echoDo "Domain không tồn tại trên hệ thống này"
    . /etc/wptt/wptt-ssl-main
    exit
fi

echo "Đang tiến hành kiểm tra chứng chỉ SSL website $NAME"

checkssl=$(curl -Is https://${NAME} | head -n 1 | grep -c "200")
ssl="/etc/letsencrypt/live/$NAME/cert.pem"
ssl_tra_phi="/usr/local/lsws/$NAME/ssl/cert.pem"

if [[ -f "$ssl_tra_phi" ]]; then
    ssl="/usr/local/lsws/$NAME/ssl/cert.crt"
fi

if [[ "$checkssl" = "0" && ! -f "$ssl" ]]; then
	echoDo "Hệ thống kiếm tra website $NAME chưa được cài đặt chứng chỉ SSL nào"
    sleep 5
    . /etc/wptt/wptt-ssl-main 1
    exit
fi

if [[ "$checkssl" = "0" && -f "$ssl" ]]; then
	echo "Hệ thống kiểm tra website $NAME đã được cài đặt chứng chỉ SSL"
	echo "nhưng website $NAME không hoạt động với chứng chỉ SSL"
echo "Vui lòng khắc phục sự cố"
	check_open_port=$(netstat -tulpn | grep LISTEN | grep ':443')
if [[ $check_open_port ]];then
	echo "Port 443 đang hoạt động tốt"
else
	echo "Port 443 không hoạt động"
    echo "Hình như đã có vấn đề về tường lửa firewall (Firewall cloud) vui lòng mở cổng port 443 để sử dụng giao thức HTTPS (SSL)"
    echo "Mở tường lửa Firewall cloud hãy liên hệ với đơn vị cung cấp dịch vụ máy chủ để bạn có thể mở cổng port"
fi


    exit
fi

echo "Xác nhận chứng chỉ SSL website $NAME đang hoạt động tốt"
echo ""
echo "Dưới đây là một số thông tin của chứng chỉ SSL hiện tại của website $NAME :"

openssl x509 -in $ssl -noout -text 

echo "Hệ thống xác nhận website $NAME đã được cài đặt thành công SSL (HTTPS)"
check_menu_wptangtoc_active=$1
if [[ $check_menu_wptangtoc_active = "98" ]];then
. /etc/wptt/wptt-ssl-main 1
fi


