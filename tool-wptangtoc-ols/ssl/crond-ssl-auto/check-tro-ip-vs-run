#!/bin/bash

NAME=$1
if [[ -d /etc/letsencrypt/live/$NAME ]];then
rm -f /etc/cron.d/cai-ssl-auto-$NAME-tu-dong.cron
systemctl restart crond.service
exit
fi

checkdns=$(host $NAME | grep -Eo -m 1 '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}')
if [[ "$checkdns" = "" ]]; then
    checkdns=$(nslookup $NAME | grep Address | cut -f5 | grep -Eo -m 1 '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}')
fi


ip=$(ip a | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' | sed '/127.0.0.1/d' | sed '/192.168/d' | sort -u)
ip+=$(curl -s myip.directadmin.com)

#tro ve quay lai
if [[ $(echo $ip | grep $checkdns) = '' ]]; then
return 2>/dev/null ; exit
fi

. /etc/wptt/ssl/wptt-caissl $NAME
rm -f /etc/cron.d/cai-ssl-auto-$NAME-tu-dong.cron
systemctl restart crond.service

