#!/bin/bash
# @author: Gia Tuấn
# @website: https://wptangtoc.com
# @since: 2022
echo ""
echo ""
echo ""
echo "========================================================================="
echo "|Quản lý SSL => Cài đặt tự động cài đặt ssl SSL FREE letsencrypt        |"
echo "========================================================================="

. /etc/wptt/echo-color

NAME=$1
if [[ $NAME = "98" ]];then
NAME=""
fi

if [[ "$NAME" = "" ]]; then
    . /etc/wptt/tenmien
    echo ""
    echo ""
    echo "Lựa chọn website bạn muốn cài đặt chứng chỉSSL letsencrypt tự động (HTTPS): "
    echo ""
    lua_chon_NAME
fi

if [[ $NAME = "0" || $NAME = '' ]];then
    . /etc/wptt/wptt-ssl-main 1
fi

path="/etc/wptt/vhost/.$NAME.conf"
if [[ ! -f "$path" ]]; then
    clear
    echoDo "Domain không tồn tại trên VPS này."
    sleep 3
    . /etc/wptt/wptt-ssl-main 1
    exit
fi


if [[ -d /etc/letsencrypt/live/$NAME ]];then
	echo "Đã kích hoạt ssl trước đó rồi"
	if [[ -f /etc/cron.d/cai-ssl-auto-$NAME-tu-dong.cron ]];then
		rm -f /etc/cron.d/cai-ssl-auto-$NAME-tu-dong.cron
		systemctl restart crond.service
	fi
	exit
fi


if [[ -f /etc/cron.d/cai-ssl-auto-$NAME-tu-dong.cron ]];then
echo "Đã kích hoạt tự động cài ssl"
exit
fi

cat >"/etc/cron.d/cai-ssl-auto-$NAME-tu-dong.cron" <<END
*/2 * * * /etc/wptt/ssl/crond-ssl-auto/check-tro-ip-vs-run $NAME
END

echo "Tự động kiểm tra và tiến hành cài ssl cứ 2 phút 1 lần cho website $NAME"
systemctl restart crond.service

