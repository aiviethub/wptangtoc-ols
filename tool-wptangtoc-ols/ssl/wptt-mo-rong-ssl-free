#!/bin/bash
# @author: Gia Tuáº¥n
# @website: https://wptangtoc.com
# @since: 2022
echo ""
echo ""
echo ""
echo "========================================================================="
echo "|Quan ly SSL => Mo rong alias SSL FREE letsencrypt                      |"
echo "========================================================================="

. /etc/wptt/echo-color

NAME=$1
if [[ $NAME = "98" ]];then
NAME=""
fi

if [[ "$NAME" = "" ]]; then
    . /etc/wptt/tenmien
    echo ""
    echo ""
    echo "Lua chon website muon cai SSL (HTTPS): "
    echo ""
    lua_chon_NAME
fi

path="/etc/wptt/vhost/.$NAME.conf"
if [[ ! -f "$path" || "$NAME" = "0" ]]; then
    clear
    echoDo "Domain khong ton tai tren VPS."
    sleep 3
    . /etc/wptt/wptt-ssl-main
    exit
fi


if [[ ! -d /usr/local/lsws/$NAME/html ]]; then
    echoDo "He thong khong xac nhan duoc thu muc ma nguon cua $NAME"
    echoDo "Thu muc ma nguon tieu chuan cua WPTangToc OLS: /usr/local/lsws/$NAME/html khong hop le"
    echoDo "Nguyen nhan dan den viec nay co the ban da thay doi cau truc thu muc hoac su dung unikey de them tien mien"
    echoDo "Vui long kiem tra lai duong dan thu muc cua ban"
    echoDo "Ho tro sua loi		: https://wptangtoc.com/lien-he/"
    exit
fi


if [[ ! -f "/etc/letsencrypt/live/$NAME/cert.pem" ]]; then
	echo "Website $NAME chua cai dat chung chi SSL letsencrypt"
echo "Ban co the cai dat chung chi ssl letsencrypt roi quay tro lai su dung tinh nang nay"
    . /etc/wptt/wptt-ssl-main
	exit
fi


#ip chinh cua domain
checkdns=$(host $NAME | grep -Eo -m 1 '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}')
if [[ "$checkdns" = "" ]]; then
    checkdns=$(nslookup $NAME | grep Address | cut -f5 | grep -Eo -m 1 '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}')
fi


# ip may chu vps hien tai
ip=$(curl -s myip.directadmin.com)
if [[ "$ip" = "" ]]; then
    ip=$(curl -s ifconfig.me)
fi

# kiem tra www da co ip chua
checkdnscname=$(host www.$NAME | grep -Eo -m 1 '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}')
if [[ "$checkdnscname" = "" ]]; then
    checkdnscname=$(nslookup www.$NAME | grep Address | cut -f5 | grep -Eo -m 1 '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}')
fi


#check tro ip ve domain chua
if [[ ! -f /etc/wptt/.cloudflare/wptt-$NAME.ini ]];then

if [[ "$checkdns" != "$ip" ]]; then
    checknameserver=$(host -t ns $NAME)
    echo "Cai ssl khong thanh cong bao loi error"
    echo "Ban chua tro ten mien dns ve webhost ip: $ip moi"
    echo "Hay tro dns thi moi co the cai duoc ssl"
    echo "Hay tro DNS $checkdns thanh $ip roi quay lai cai ssl nhe"
    if [[ "$checkdns" = "" ]]; then
        echo "Ten mien $NAME chua duoc tro IP gia tri IP cua $NAME la khong co gia tri nao, ban vui long tro IP ve $ip"
    fi
    echo "Ten mien $NAME dang duoc su dung quan ly boi $checknameserver ban hay truy cap vao do de tro ten mien cua minh"
    exit
fi

fi

rm -f /tmp/ssl-$NAME.txt

ssl_actives=$(openssl x509 -in /etc/letsencrypt/live/$NAME/cert.pem -noout -text | grep 'DNS'| sed 's/DNS://g' | sed 's/,//g' | xargs | tr -s ' ' '\n')
for ssl_active in ${ssl_actives[@]};do
	echo "$ssl_active" >> /tmp/ssl-$NAME.txt
done

		a="y"
		while [[ $a = "y" ]]
	do
		read -p "Vui long nhap subdomain ban muon mo rong vi du cdn.$NAME hay blog.$NAME ... : " subdomain
		subdomain=$(echo $subdomain | sed "s/.$NAME//g" | sed "s/$/.$NAME/g" | sed 's#https://##g' | sed 's#http://##g' )
		echo "Tien hanh add domain $subdomain chuan bi cai SSL"
		echo "$subdomain" >> /tmp/ssl-$NAME.txt
		read -p "Ban co muon tiep tuc them subdomain mo rong ssl nua khong? (y/n): " a
	done


#tu dong them subdomain multisite wordpress
if [[ -f /usr/local/lsws/$NAME/html/wp-config.php ]]; then
check_mulsite_dang_su_dung=$(cat /usr/local/lsws/$NAME/html/wp-config.php | grep MULTISITE)
if [[ $check_mulsite_dang_su_dung ]];then
	sub_domain_multisite=$(wp site list --field=url --path=/usr/local/lsws/$NAME/html --allow-root 2>/dev/null | cut -f3 -d '/' | sort -u | uniq)
	echo "$sub_domain_multisite" >> /tmp/ssl-$NAME.txt
fi
fi

#kiem tra mo rong ssl da tro ip chua

if [[ ! -f /etc/wptt/.cloudflare/wptt-$NAME.ini ]];then
if [[ -f /tmp/ssl-$NAME.txt ]];then
	multisite_check_dns_tro_ip_chua=($(cat /tmp/ssl-$NAME.txt))
	for multisite in ${multisite_check_dns_tro_ip_chua[@]};do
		multisite_check_dns=$(host $multisite | grep -Eo -m 1 '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}')
		if [[ $multisite_check_dns != $ip ]];then
echo "domain $multisite chua tro dns ve $ip de co the cai SSL"
sed -i "/$multisite/d" /tmp/ssl-$NAME.txt
		fi
	done
fi
fi

echo "$NAME" >> /tmp/ssl-$NAME.txt

if [[ "$checkdns" = "$checkdnscname" ]]; then
	echo "www.$NAME" >> /tmp/ssl-$NAME.txt
fi

echo "Dang tien hanh cai SSL cho website $NAME..."
list_all_ssl_thong_bao=($(cat /tmp/ssl-$NAME.txt | sort -u | sed '/^$/d' | uniq))
for domain_ssl in ${list_all_ssl_thong_bao[@]};do
echo "Tien hanh cai dat ssl domain: $domain_ssl"
done

list_ssl_domain_all=$(cat /tmp/ssl-$NAME.txt | sort -u |uniq |sed '/^$/d' | sed 's/^/-d /g' | tr -s '\n' ' ')


if [[ -f /etc/wptt/.cloudflare/wptt-$NAME.ini ]];then
	cloudflare="--dns-cloudflare --dns-cloudflare-credentials /etc/wptt/.cloudflare/wptt-$NAME.ini"
fi
certbot certonly $cloudflare --non-interactive --agree-tos --register-unsafely-without-email --expand --webroot -w /usr/local/lsws/$NAME/html/ $list_ssl_domain_all

clear
echo "Kiem tra chung chi SSL website $NAME..."
echo "Vui long doi..."
sleep 1
/usr/local/lsws/bin/lswsctrl restart
sleep 2
checkssl2=$(curl -Is https://${NAME} | grep -c "WPTangTocOLS")
if [[ ! -f "/etc/letsencrypt/live/$NAME/cert.pem" || "$checkssl2" = "0" ]]; then
    echo "Qua trinh cai dat SSL khong thanh cong, da xay ra loi"
    if [[ -f "/etc/letsencrypt/live/$NAME/cert.pem" ]]; then
        echo "Chung chi ssl cua ban da duoc cai dat, kiem tra thuc te https://$NAME thi khong hoat dong"
        . /etc/wptt/.wptt.conf
        if [[ "$Website_chinh" != "$NAME" && ! -f "/etc/letsencrypt/live/$Website_chinh/cert.pem" && ! -d "/usr/local/lsws/$Website_chinh/ssl" ]]; then
            echo "Website chinh $Website_chinh chua duoc cai ssl, vui long cai dat ssl cho website $Website_chinh truoc thi cac website khac moi co the su dung HTTPS"
        fi
    else
    vang='\033[1;33m'
NC='\033[0m'
echo -e "${vang}                                              
                   .:::....                   
                 .--=+++=-::.                 
                :--*%%%%%%+::.                
               :--*%%%%%%%%*:::               
              ---#%%%%%#%%%%*:::              
            .--=#%%%#=--=#%%%#-::             
           .--=%%%%%*:-:.*%%%%#-::.           
          .--+%%%%%%*---:*%%%%%#=::.          
         :--*%%%%%%%*--::*%%%%%%#+::.         
        :--*%%%%%%%%*--::*%%%%%%%#+:::        
       ---#%%%%%%%%%*--::*%%%%%%%%#*:::       
      --=#%%%%%%%%%%*---:*%%%%%%%%%#*-::      
    .--=%%%%%%%%%%%%#--::#%%%%%%%%%%##-::     
   .--+%%%%%%%%%%%%%%#*+#%%%%%%%%%%%%##=::.   
  :--+%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%##=::.  
 :--*%%%%%%%%%%%%%%%#=-:-#%%%%%%%%%%%%%##+::. 
:--*%%%%%%%%%%%%%%%%#--::#%%%%%%%%%%%%%%##+::.
--=%%%%%%%%%%%%%%%%%%%##%%%%%%%%%%%%%%%%###-::
:--*%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%##+::.
 :--=++***************++++++++++++++++++=-::. 
   .:::::::::::::::::::....................  
${NC}"
        echo "Chung chi SSL cai dat khong thanh cong, ban co the xem log nguyen nhan khong cai duoc ssl tai day: cd /var/log/letsencrypt"
    fi

    exit
else
echo '          :.::::::::::::::::::::::.:          
         -*+======================+*=         
         +*..================----..*+         
        =*- #@@@@@@@##**##@@@%###* -*=        
      :+*+.*@%%%@#--======--#@#**#+ :*+:      
   .-++=.*@@%%%@=.**======**.=@%#*#*..=++-.   
  .*+-.-*%%%%%@* %* +%%%%+ *% +@%%###+:.-+*.  
  .++ -@@%%%%%@::@ +@@@@@@+ @::@%@@####- ++.  
   =*:.%%%%%%%@:.# -#****#= #..@%%%####.:*=   
   :*+ +@%%%%%..:..........:.:..%@####= =*:   
    =*: %@%%@% :=***++***=*===: %%*##* :*=    
    .+*..@@%@% :=##*=+%*+=@=-=: ##*##..++.    
     :++ :@@%% :=++%#=+#@+@+==: *###: ++:     
      :++..%@% :=+**=+**+=***+: *#*..++:      
       .+*: *@:.:..............:##=:*+.       
         =*- =@%##########%#***#-.+*=.        
          :*+..*@@@@@@@@@@%###=..++:          
           .=*=.:*@@%%@%%###+..=*=.           
             .=*=.:*@@%###+:.=*=.             
               :=*=.:=**=..=*=:               
                 .=*+:..:+*=.                 
                   .-++++-.                   
                      ..                      
'
    echoDone "Kiem tra hoan tat: SSL duoc cai dat thanh cong"
fi
sleep 2

clear

function box_out() {
    local s=("$@") b w
    for l in "${s[@]}"; do
        ((w < ${#l})) && {
            b="$l"
            w="${#l}"
        }
    done
    tput setaf 7
    echo " -${b//?/-}-
| ${b//?/ } |"
    for l in "${s[@]}"; do
        printf '| %s%*s%s |\n' "$(tput setaf 7)" "-$w" "$l" "$(tput setaf 3)"
    done
    echo "| ${b//?/ } |
 -${b//?/-}-"
    tput sgr 0
}


box_out "Cai Dat SSL website $NAME thanh cong"
box_out "Thu muc chung chi: /etc/letsencrypt/live/$NAME"

echo "========================================================================="
echo "Cong cu phat trien boi	: Gia Tuan"
echo "Yeu Cau Ho tro		: wptangtoc.com/lien-he"
echo "Tai tro phat trien	: wptangtoc.com/donate"
echo "========================================================================="

/usr/local/lsws/bin/lswsctrl restart >/dev/null 2>&1

check_menu_wptangtoc_active=$1
if [[ $check_menu_wptangtoc_active = "98" ]];then
. /etc/wptt/wptt-ssl-main 1
fi

