#!/bin/bash

echo ""
echo ""
echo ""
echo "========================================================================="
echo "|Giả lập => Nhân bản giả lập website                                     |"
echo "========================================================================="
. /etc/wptt/tenmien
echo ""
echo ""
echo "Lựa chọn website bạn muốn nhân bản giả lập: "
lua_chon_NAME

. /etc/wptt/echo-color


if [[ "$NAME" = "0" || "$NAME" = "" ]]; then
	. /etc/wptt/wptt-gia-lap-main 1
fi

pathcheck="/etc/wptt/vhost/.$NAME.conf"
if [[ ! -f "$pathcheck" ]]; then
    clear
	echoDo "Tên miền không tồn tại trên hệ thống này"
    sleep 3
		. /etc/wptt/wptt-gia-lap-main 1
    exit
fi


pathcheckwp="/usr/local/lsws/$NAME/html/wp-load.php"
if [[ ! -f "$pathcheckwp" ]]; then
	clear
	echoDo "Hệ thống xác nhận bạn không sử dụng WordPress"
	echoDo "Tính năng này chỉcó thể hoạt động trên WordPress"
	sleep 3
	. /etc/wptt/wptt-gia-lap-main 1
	exit
fi


domain_phuc_vu="wptangtoc-ols.com"

ten_ngau_nhien=$(date +%s | sha256sum | base64 | head -c 3 ; echo)
ten_mien_random=${NAME//[-._]/$ten_ngau_nhien}
subdomain_ten_mien=$(echo $ten_mien_random | tr '[:upper:]' '[:lower:]')


ip=$(curl -s myip.directadmin.com)
if [[ "$ip" = "" ]]; then
  ip=$(curl -s ifconfig.me)
fi

_runing "Cấu hình domain giả lập ${subdomain_ten_mien}.${domain_phuc_vu}"
. /etc/wptt/gia-lap-website/cf-dns.sh -d "$domain_phuc_vu" -n "$subdomain_ten_mien" -t A -c "$ip" -p 0 -l 1 -x n
_rundone "Cấu hình domain giả lập ${subdomain_ten_mien}.${domain_phuc_vu}"

_runing "Sao chép website $NAME sang website giả lập ${subdomain_ten_mien}.${domain_phuc_vu}"
. /etc/wptt/wptt-sao-chep-website $NAME ${ten_mien}.wptangtoc-ols.com >/dev/null 2>&1
_rundone "Sao chép website $NAME sang website giả lập ${subdomain_ten_mien}.${domain_phuc_vu}"


wp option set blog_public 0 --allow-root --path=/usr/local/lsws/${subdomain_ten_mien}.${domain_phuc_vu}/html >/dev/null 2>&1

if [[ -f /usr/local/lsws/${subdomain_ten_mien}.${domain_phuc_vu}/html/robots.txt ]];then
cp -f /usr/local/lsws/${subdomain_ten_mien}.${domain_phuc_vu}/html/robots.txt /tmp/${subdomain_ten_mien}.${domain_phuc_vu}-robots.txt
fi

echo "Disallow: *" > /usr/local/lsws/${subdomain_ten_mien}.${domain_phuc_vu}/html/robots.txt
check_dns=$(ping -c 1 ${subdomain_ten_mien}.${domain_phuc_vu}) 

while [[ $check_dns = '' ]];do
_runing "Xác thực dns domain ${subdomain_ten_mien}.${domain_phuc_vu}"
check_dns=$(host ${subdomain_ten_mien}.${domain_phuc_vu} |grep -Eo -m 1 '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}') 
sleep 3
done

_rundone "Xác thực dns domain ${subdomain_ten_mien}.${domain_phuc_vu}"

wptt ssl ${subdomain_ten_mien}.wptangtoc-ols.com
echo "domain_gia_lap=1" >> /etc/wptt/vhost/.${subdomain_ten_mien}.${domain_phuc_vu}.conf
echo "==================================================================="
echo "Hoàn tất giả lập website $NAME sang ${subdomain_ten_mien}.${domain_phuc_vu}"
echo "==================================================================="
echo "Truy cập: https://${subdomain_ten_mien}.${domain_phuc_vu}"
echo "Mọi tài khoản WordPress thì vẫn như domain gốc"
echo "==================================================================="

check_menu_wptangtoc_active=$1
if [[ $check_menu_wptangtoc_active = "98" ]];then
	. /etc/wptt/wptt-gia-lap-main 1
fi


