#!/bin/bash
# @author: Gia Tuấn
# @website: https://wptangtoc.com
# @since: 2022

echo "========================================================================="
echo "|Quản lý Cache => Kích hoạt Memcached	   	                              |"
echo "========================================================================="


if [[ -f /etc/sysconfig/memcached ]];then
echo "Bạn đã kích hoạt đã kích hoạt memcached"
. /etc/wptt/wptt-cache-main 1
fi


read -p "Bạn có muốn cài đặt object cache Memcached không (y/n): " dongy

if [[ $dongy != 'y' ]];then
. /etc/wptt/wptt-cache-main 1
exit
fi

if [[ -f /etc/sysconfig/memcached ]];then
echo "Bạn đã kích hoạt đã kích hoạt memcached"
. /etc/wptt/wptt-cache-main 1
fi

echo 'Tiến hành cài đặt memcached'
        echo '[litespeed]
name=LiteSpeed Tech Repository for CentOS $releasever - $basearch
baseurl=http://rpms.litespeedtech.com/centos/$releasever/$basearch/
failovermethod=priority
enabled=1
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-litespeed

[litespeed-update]
name=LiteSpeed Tech Update Repository for CentOS $releasever - $basearch
baseurl=http://rpms.litespeedtech.com/centos/$releasever/update/$basearch/
failovermethod=priority
enabled=1
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-litespeed

[litespeed-edge]
name=LiteSpeed Tech Edge Repository for CentOS $releasever - $basearch
baseurl=http://rpms.litespeedtech.com/edge/centos/$releasever/$basearch/
failovermethod=priority
enabled=0
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-litespeed

[litespeed-edge-update]
name=LiteSpeed Tech Edge Update Repository for CentOS $releasever - $basearch
baseurl=http://rpms.litespeedtech.com/edge/centos/$releasever/update/$basearch/
failovermethod=priority
enabled=0
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-litespeed
' >/etc/yum.repos.d/litespeed.repo


yum install memcached -y

lsphp=($(ls /usr/local/lsws | grep 'lsphp' | sed 's/^lsphp//g'))
for phpredis in ${lsphp[@]};do
yum install lsphp${phpmemcached}-pecl-memcached -y
done


        echo '[litespeed]
name=LiteSpeed Tech Repository for CentOS $releasever - $basearch
baseurl=http://rpms.litespeedtech.com/centos/$releasever/$basearch/
failovermethod=priority
enabled=1
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-litespeed

[litespeed-update]
name=LiteSpeed Tech Update Repository for CentOS $releasever - $basearch
baseurl=http://rpms.litespeedtech.com/centos/$releasever/update/$basearch/
failovermethod=priority
enabled=0
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-litespeed

[litespeed-edge]
name=LiteSpeed Tech Edge Repository for CentOS $releasever - $basearch
baseurl=http://rpms.litespeedtech.com/edge/centos/$releasever/$basearch/
failovermethod=priority
enabled=0
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-litespeed

[litespeed-edge-update]
name=LiteSpeed Tech Edge Update Repository for CentOS $releasever - $basearch
baseurl=http://rpms.litespeedtech.com/edge/centos/$releasever/update/$basearch/
failovermethod=priority
enabled=0
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-litespeed
' >/etc/yum.repos.d/litespeed.repo


mkdir -p /usr/local/lsws/memcached
chown -R memcached:memcached /usr/local/lsws/memcached

#config memcached unix socket
echo "USER=\"memcached\"
MAXCONN=\"10240\"
CACHESIZE=\"128\"
OPTIONS=\"-s '/usr/local/lsws/memcached/memcached.sock' -a 0766\"" > /etc/sysconfig/memcached

semanage permissive -a memcached_t

echo "Hoàn tất cài đặt object cache memcached"

systemctl enable memcached.service
systemctl start memcached.service
systemctl restart lsws
echo "========================================================================="
echo "Bạn có thể sử dụng plugin LiteSpeed cache để kích hoạt và quản trị object cache memcached"
echo "Địa chỉkết nối unix stocket: /usr/local/lsws/memcached/memcached.sock"
echo "========================================================================="


check_menu_wptangtoc_active=$1
if [[ $check_menu_wptangtoc_active = "98" ]];then
. /etc/wptt/wptt-cache-main 1
fi

