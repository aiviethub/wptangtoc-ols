#!/bin/bash
# @author: Gia Tuấn
# @website: https://wptangtoc.com
# @since: 2022

echo "========================================================================="
echo "|Quản lý Cache => Kích hoạt Memcached	   	                              |"
echo "========================================================================="

tong_ram_byte=$(awk '/MemTotal/ {print $2}' /proc/meminfo)
rong_ram_mb=$(echo "scale=0;${tong_ram_byte}/1024" | bc)
if [[ "$rong_ram_mb" = "" ]]; then
  rong_ram_mb="2048"
fi
if (( $rong_ram_mb  < 1024 ));then
echo "Chỉ nên sử dụng object cache khi tối thiểu 2GB Ram, hiện tại hệ thống của bạn không đủ khả năng đáp ứng nhu cầu này"
	. /etc/wptt/wptt-cache-main 1
fi

if [[ -f /etc/sysconfig/memcached ]];then
echo "Bạn đã kích hoạt đã kích hoạt memcached"
. /etc/wptt/wptt-cache-main 1
fi


read -p "Bạn có muốn cài đặt object cache Memcached không (y/n): " dongy

if [[ $dongy != 'y' ]];then
. /etc/wptt/wptt-cache-main 1
exit
fi

if [[ -f /etc/sysconfig/memcached ]];then
echo "Bạn đã kích hoạt đã kích hoạt memcached"
. /etc/wptt/wptt-cache-main 1
fi

. /etc/wptt/echo-color
_runing 'Cài đặt memcached'
        echo '[litespeed]
name=LiteSpeed Tech Repository for CentOS $releasever - $basearch
baseurl=http://rpms.litespeedtech.com/centos/$releasever/$basearch/
failovermethod=priority
enabled=1
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-litespeed

[litespeed-update]
name=LiteSpeed Tech Update Repository for CentOS $releasever - $basearch
baseurl=http://rpms.litespeedtech.com/centos/$releasever/update/$basearch/
failovermethod=priority
enabled=1
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-litespeed

[litespeed-edge]
name=LiteSpeed Tech Edge Repository for CentOS $releasever - $basearch
baseurl=http://rpms.litespeedtech.com/edge/centos/$releasever/$basearch/
failovermethod=priority
enabled=0
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-litespeed

[litespeed-edge-update]
name=LiteSpeed Tech Edge Update Repository for CentOS $releasever - $basearch
baseurl=http://rpms.litespeedtech.com/edge/centos/$releasever/update/$basearch/
failovermethod=priority
enabled=0
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-litespeed
' >/etc/yum.repos.d/litespeed.repo


yum install memcached -y >/dev/null 2>&1

lsphp=($(ls /usr/local/lsws | grep 'lsphp' | sed 's/^lsphp//g'))
for phpmemcached in ${lsphp[@]};do
yum install lsphp${phpmemcached}-pecl-memcached -y >/dev/null 2>&1
done


        echo '[litespeed]
name=LiteSpeed Tech Repository for CentOS $releasever - $basearch
baseurl=http://rpms.litespeedtech.com/centos/$releasever/$basearch/
failovermethod=priority
enabled=1
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-litespeed

[litespeed-update]
name=LiteSpeed Tech Update Repository for CentOS $releasever - $basearch
baseurl=http://rpms.litespeedtech.com/centos/$releasever/update/$basearch/
failovermethod=priority
enabled=0
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-litespeed

[litespeed-edge]
name=LiteSpeed Tech Edge Repository for CentOS $releasever - $basearch
baseurl=http://rpms.litespeedtech.com/edge/centos/$releasever/$basearch/
failovermethod=priority
enabled=0
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-litespeed

[litespeed-edge-update]
name=LiteSpeed Tech Edge Update Repository for CentOS $releasever - $basearch
baseurl=http://rpms.litespeedtech.com/edge/centos/$releasever/update/$basearch/
failovermethod=priority
enabled=0
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-litespeed
' >/etc/yum.repos.d/litespeed.repo


mkdir -p /usr/local/lsws/memcached
chown -R memcached:memcached /usr/local/lsws/memcached

#config memcached unix socket
echo "USER=\"memcached\"
MAXCONN=\"10240\"
CACHESIZE=\"128\"
OPTIONS=\"-s '/usr/local/lsws/memcached/memcached.sock' -a 0766\"" > /etc/sysconfig/memcached

semanage permissive -a memcached_t

_rundone 'Cài đặt memcached'

systemctl enable memcached.service >/dev/null 2>&1
systemctl start memcached.service >/dev/null 2>&1
systemctl restart lsws >/dev/null 2>&1
echo "========================================================================="
echo "Bạn có thể sử dụng plugin LiteSpeed cache để kích hoạt và quản trị object cache memcached"
echo "Địa chỉ kết nối unix stocket: /usr/local/lsws/memcached/memcached.sock"
echo "========================================================================="


check_menu_wptangtoc_active=$1
if [[ $check_menu_wptangtoc_active = "98" ]];then
. /etc/wptt/wptt-cache-main 1
fi

