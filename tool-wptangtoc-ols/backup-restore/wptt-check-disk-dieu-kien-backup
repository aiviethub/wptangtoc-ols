#!/bin/bash

# --- Cấu hình ---
backup_dir="$1"
zip_file="$2"
min_free_space_gb=1

# 0.75: Hỗn hợp (nén trung bình)
compression_ratio=0.75

# --- Hàm ---
dir_size() {
  du -sb "$1" | awk '{print $1}'
}

bytes_to_gb() {
  echo "scale=2; $1 / 1024 / 1024 / 1024" | bc
}

# --- Kiểm tra ---
if [ -z "$backup_dir" ] || [ -z "$zip_file" ]; then
  echo "Lỗi: Thiếu đối số."
  echo "Cách dùng: $0 /path/to/data backup.zip"
  return 2>/dev/null;exit 1
fi

if [ ! -d "$backup_dir" ]; then
  echo "Lỗi: '$backup_dir' không tồn tại."
  return 2>/dev/null;exit 1
fi

# --- Tính toán ---
dir_size_bytes=$(dir_size "$backup_dir")
estimated_zip_size_bytes=$(echo "scale=0; $dir_size_bytes * $compression_ratio" | bc)
estimated_zip_size_gb=$(bytes_to_gb "$estimated_zip_size_bytes")

output_dir=$(dirname "$zip_file")
if [ "$output_dir" = "." ]; then
  output_dir=$(pwd)
fi
free_space_bytes=$(df -B1 "$output_dir" | awk 'NR==2 {print $4}')
free_space_gb=$(bytes_to_gb "$free_space_bytes")

# --- So sánh ---
if (( $(echo "$free_space_gb >= ($estimated_zip_size_gb + $min_free_space_gb)" | bc -l) )); then
dieu_kien_disk='1'
else
dieu_kien_disk='0'
  echo "KHÔNG ĐỦ DUNG LƯỢNG DISK ổ cứng để backup!"
  echo "- Thư mục: $(bytes_to_gb "$dir_size_bytes") GB"
  echo "- Ước tính ZIP: $estimated_zip_size_gb GB (dựa trên nén mặc định của zip)"
  echo "- Trống: $free_space_gb GB"
  echo "- Tối thiểu: $min_free_space_gb GB"
  echo "- Cần thêm: $(bytes_to_gb "$((estimated_zip_size_bytes + (min_free_space_gb * 1024 * 1024 * 1024) - free_space_bytes))") GB"
fi
