#!/bin/bash
echo ""
echo ""
echo ""
echo "============================================================================="
echo "|Sao luu & khoi phuc => Sao luu tat cac website va Uploads len Google Driver"
echo "============================================================================="
echo ""
echo ""

checkdathietlap=$(grep -rnw '/root/.config/rclone/rclone.conf' -e "wptangtoc" >>/dev/null 2>&1 && echo 1)
if [[ "$checkdathietlap" = "" ]]; then
  echo "ban chua thiet lap Google Driver"
  exit
fi

echo "Bạn có muốn khi đã uploads lên Google Drive xong rồi có muốn xóa file backup tại local không?"

prompt="Nhập lựa chọn của bạn [1-2]: "
dongyxoa="n"
options=("Đồng ý" "Không đồng ý")
PS3="$prompt"
select opt in "${options[@]}"; do
	case "$REPLY" in
		1)
			dongyxoa="y"
			break
			;;

		2)
			dongyxoa="n"
			break
			;;

		$((${#options[@]} + 1)))
			printf "\nBạn nhập sai hệ thống sẽ chọn là không đồng ý\n"
			break
			;;
		*)
			printf "Bạn nhập sai hệ thống sẽ chọn là không đồng ý\n"
			break
			;;
	esac
done


if [[ "$dongyxoa" = "y" ]]; then
giatuandz="1998"
else
giatuandz="12345"
fi
pathcheck_full="/usr/local/backup-website"
before_optimize_full=$(du -hs $pathcheck_full)

echo "Sao lưu Backup toàn bộ website trên hệ thống"
if [ "$(ls -A /etc/wptt/vhost)" ]; then
  for entry in $(ls -A /etc/wptt/vhost); do
    domain=$(echo $entry | sed 's/^.//' | sed 's/.conf//')
    path="/usr/local/lsws/$domain/html"
    i=1

    if [[ -d "$path" ]]; then
      . /etc/wptt/backup-restore/wptt-saoluu "$domain" 1998 $giatuandz
    fi
  done
fi
clear
echo '               .::------------:--                
               -==-------------=##+               
              -====-----------+####*.             
            .=======---------+######*.            
           .=========-------*#########:           
          .============----*###########-          
         :==============--*#############-         
        :===============-+###############=        
       -===============:  =###############+       
      -===============:    =###############+      
     -===============:      -###############*.    
   .================.        :###############*.   
  .================.          :################:  
 .===============-.            .*###############: 
:===============-                +###############-
----------------:................:+***************
:--------------==================================:
 :------------==================================: 
  .----------==================================:  
   .-------===================================:   
    .-----===================================.    
      :--===================================.     
       .-================================-:       
'
echo "==================================================================="
echo "Hoàn tất sao lưu tất cả các website của bạn"
echo "==================================================================="
echo "Đã sao lưu backup các website: "

for entry in $(ls -A /etc/wptt/vhost); do
  domain=$(echo $entry | sed 's/^.//' | sed 's/.conf//')
  path="/usr/local/lsws/$domain/html"
  i=1

  if [[ -d "$path" ]]; then
    echo "Hoàn tất backup website: $domain"
  fi
done
echo "==================================================================="
echo "Dung luong thu muc truoc khi backup	: $before_optimize_full"
echo "Dung luong thu muc sau khi backup	: $(du -hs $pathcheck_full)"
echo "==================================================================="
echo "==================================================================="
echo "Dung luong Google Driver cua ban		: $(rclone size wptangtoc:)"
echo "==================================================================="
echo "Cong cu phat trien boi	: Gia Tuan"
echo "Yeu Cau Ho tro		: https://wptangtoc.com/lien-he"
echo "Ho tro phat trien	: https://wptangtoc.com/donate"
echo "==================================================================="

check_menu_wptangtoc_active=$1
if [[ $check_menu_wptangtoc_active = "98" ]];then
. /etc/wptt/wptt-backup-restore-main 1
fi

