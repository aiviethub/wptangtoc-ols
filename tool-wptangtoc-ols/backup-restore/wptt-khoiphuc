#!/bin/bash
#
#
# @author: Gia Tuấn
# @website: https://wptangtoc.com
# @since: 2021
echo ""
echo ""
echo ""
echo "========================================================================="
echo "|Sao luu & khoi phuc => Khoi phuc website                               |"
echo "========================================================================="
. /etc/wptt/.wptt.conf

NAME=$1
if [[ "$NAME" = "" ]];then
. /etc/wptt/tenmien
echo ""
echo ""
echo "lua chon website ban muon khoi phuc: "
echo ""
lua_chon_NAME
fi

pathcheck="/etc/wptt/vhost/.$NAME.conf"
if [[ ! -f "$pathcheck" || "$NAME" = "0" ]]; then
	clear
	. /etc/wptt/wptt-backup-restore-main
	exit
fi
. /etc/wptt/vhost/."$NAME".conf

if [ ! "$(ls -A /usr/local/backup-website/$NAME/)" ]; then
	clear
	echo "Không có file backup nào tồn tại."
	echo "Vui lòng uploads file backup của bạn vào: /usr/local/backup-website/$NAME/"
	echo
fi

selects=()
for entry in $(ls -A /usr/local/backup-website/$NAME/ | grep ".zip"); do
	selects+=("$entry")
done

PS3="
-//- Nhap lua chon cua ban [0=Thoat]: "
select select in ${selects[@]}; do
	file=$select
	break
done

if [[ "$file" = "" ]]; then
	clear
	echo "Khong co file backup nao ton tai trong thu muc /usr/local/backup-website/$NAME/"
	echo "Ban hay upload ma nguon .zip"
	exit
	sleep 3
fi

duong_dan_thu_muc="/usr/local/backup-website/$NAME/$file"

selects=()
for entry in $(ls -A /usr/local/backup-website/$NAME/ | grep ".sql"); do
	selects+=("$entry")
done

PS3="
-//- Nhap lua chon cua ban [0=Thoat]: "
select select in ${selects[@]}; do
	filesql=$select
	break
done

if [[ "$filesql" = "" ]]; then
	clear
	echo "Khong co file backup nao ton tai trong thu muc /usr/local/backup-website/$NAME/"
	echo "Ban hay upload database .sql"
	exit
	sleep 3
fi

duong_dan_thu_muc_sql="/usr/local/backup-website/$NAME/$filesql"

echo "hay nhap ma thoi gian ban muon khoi phuc"

echo "Dang tien hanh khoi phuc database website $NAME ..."
mysql -u "$database_admin_username" -p"$database_admin_password" -e "DROP DATABASE IF EXISTS ${DB_Name_web}"
mysql -u "$database_admin_username" -p"$database_admin_password" -e "CREATE DATABASE IF NOT EXISTS ${DB_Name_web}"
mysql -u "$database_admin_username" -p"$database_admin_password" -e "DROP USER IF EXISTS '${DB_User_web}'@'localhost'"
mysql -u "$database_admin_username" -p"$database_admin_password" -e "CREATE USER IF NOT EXISTS '${DB_User_web}'@'localhost' IDENTIFIED BY '${DB_Password_web}'"
mysql -u "$database_admin_username" -p"$database_admin_password" -e "GRANT ALL PRIVILEGES ON ${DB_Name_web}.* TO '${DB_User_web}'@'localhost' WITH GRANT OPTION"
mysql -u "$database_admin_username" -p"$database_admin_password" -e "FLUSH PRIVILEGES"
clear
echo
echo "DB_Name:  $DB_Name_web"
echo "DB_User:  $DB_User_web"
echo "DB_Password: $DB_Password_web"

mysql -u "$DB_User_web" -p"$DB_Password_web" "$DB_Name_web" <$duong_dan_thu_muc_sql
echo " da khoi phuc thanh cong database"
rm -rf /usr/local/lsws/"$NAME"/html/*
unzip "$duong_dan_thu_muc" -d /usr/local/lsws/"$NAME"/html/

if [[ -d "/usr/local/lsws/$NAME/html/domains/*/public_html" ]];then
cp -rf /usr/local/lsws/"$NAME"/html/domains/$NAME/public_html/* /usr/local/lsws/"$NAME"/html
rm -rf /usr/local/lsws/"$NAME"/html/domains
fi

rm -rf /usr/local/lsws/"$NAME"/luucache
chown -R "$User_name_vhost":"$User_name_vhost" /usr/local/lsws/"$NAME"/html
find /usr/local/lsws/"$NAME"/html -type d -exec chmod 755 {} \;
find /usr/local/lsws/"$NAME"/html -type f -exec chmod 644 {} \;

sed -i "/DB_HOST/s/'[^']*'/'localhost'/2" "/usr/local/lsws/$NAME/html/wp-config.php"
sed -i "/DB_NAME/s/'[^']*'/'$DB_Name_web'/2" "/usr/local/lsws/$NAME/html/wp-config.php"
sed -i "/DB_USER/s/'[^']*'/'$DB_User_web'/2" "/usr/local/lsws/$NAME/html/wp-config.php"
sed -i "/DB_PASSWORD/s/'[^']*'/'$DB_Password_web'/2" "/usr/local/lsws/$NAME/html/wp-config.php"
wp rewrite flush --allow-root --path=/usr/local/lsws/"$NAME"/html >/dev/null 2>&1

/usr/local/lsws/bin/lswsctrl restart >/dev/null 2>&1

echo "==================================================================="
echo "                khoi phuc website $NAME thanh cong                 "
echo "==================================================================="

echo "###################################################################"
echo "                                                                   "
echo "Disk : $(df -h | awk '$NF=="/"{printf "%d/%dGB (%s)\n", $3,$2,$5}')                        "
echo "                                                                   "
echo "                                                                   "
echo "Duong dan luu tru backup	: /usr/local/backup-website/$NAME         "
echo "duong dan thu muc website	: /usr/local/lsws/$NAME/html              "
echo "###################################################################"
echo "Cong cu phat trien boi		: Gia Tuan"
echo "Yeu Cau Ho tro			: https://wptangtoc.com/lien-he"
echo "Ho tro phat trien		: https://wptangtoc.com/donate"
