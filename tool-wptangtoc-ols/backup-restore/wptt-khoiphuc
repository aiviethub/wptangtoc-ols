#!/bin/bash
# @author: Gia Tuấn
# @website: https://wptangtoc.com
# @email: giatuan@wptangtoc.com
# @since: 2022
. /etc/wptt/.wptt.conf

NAME=$1

if [[ $NAME = "98" ]];then
NAME=""
fi

if [[ "$NAME" = "" ]];then
. /etc/wptt/tenmien
echo ""
echo ""
echo ""
echo "========================================================================="
echo "|Sao luu & khoi phuc => Khoi phuc website                               |"
echo "========================================================================="
echo ""
echo ""
echo "Lua chon website ban muon khoi phuc: "
echo ""
lua_chon_NAME
fi


. /etc/wptt/echo-color

if [[ "$NAME" = "0" || "$NAME" = "" ]]; then
	. /etc/wptt/wptt-backup-restore-main 1
fi

pathcheck="/etc/wptt/vhost/.$NAME.conf"
if [[ ! -f "$pathcheck" ]]; then
    clear
	echoDo "Tên miền không tồn tại trên hệ thống này"
    sleep 3
	. /etc/wptt/wptt-backup-restore-main 1
    exit
fi


. /etc/wptt/vhost/."$NAME".conf

if [ ! "$(ls -A /usr/local/backup-website/$NAME/)" ]; then
	clear
	echo "Không có file backup nào tồn tại."
	echo "Vui lòng uploads file backup của bạn vào: /usr/local/backup-website/$NAME/"
	echo
fi

c=1
for entry in $(ls -At /usr/local/backup-website/$NAME | grep ".zip$"); do
c=$((c+1));
done


echo "========================================================================="
echo "So luong file Zip ma nguon cua website $NAME: $((c-1))"
echo "========================================================================="


selects=()
for entry in $(ls -At /usr/local/backup-website/$NAME/ | grep ".zip$"); do
	selects+=("$entry")
done

PS3="
-//- Nhap lua chon cua ban [0=Thoat]: "
select select in ${selects[@]}; do
	file=$select
	break
done

if [[ "$file" = "" ]]; then
	clear
	echo "Khong co file backup nao ton tai trong thu muc /usr/local/backup-website/$NAME/"
	echo "Ban hay upload ma nguon .zip"
	exit
	sleep 3
fi

duong_dan_thu_muc="/usr/local/backup-website/$NAME/$file"

if [[ $sql_gz = '' ]];then
b=1
for entry in $(ls -At /usr/local/backup-website/$NAME | grep ".sql$"); do
b=$((b+1));
done
echo "========================================================================="
echo "Số lượng file backup Database của website $NAME: $((b-1))"
echo "========================================================================="


selects=()
for entry in $(ls -At /usr/local/backup-website/$NAME/ | grep ".sql$"); do
	selects+=("$entry")
done

PS3="
-//- Nhap lua chon cua ban [0=Thoat]: "
select select in ${selects[@]}; do
	filesql=$select
	break
done

if [[ "$filesql" = "" ]]; then
	clear
	echo "Khong co file backup nao ton tai trong thu muc /usr/local/backup-website/$NAME/"
	echo "Ban hay upload database .sql"
	exit
	sleep 3
fi 
fi


if [[ $sql_gz ]];then
b=1
for entry in $(ls -At /usr/local/backup-website/$NAME | grep ".sql.gz$"); do
b=$((b+1));
done
echo "========================================================================="
echo "So luong file backup Database cua website $NAME: $((b-1))"
echo "========================================================================="


selects=()
for entry in $(ls -At /usr/local/backup-website/$NAME/ | grep ".sql.gz$"); do
	selects+=("$entry")
done

PS3="
-//- Nhap lua chon cua ban [0=Thoat]: "
select select in ${selects[@]}; do
	filesql=$select
	break
done

if [[ "$filesql" = "" ]]; then
	clear
	echo "Khong co file backup nao ton tai trong thu muc /usr/local/backup-website/$NAME/"
	echo "Ban hay upload database .sql.gz"
	exit
	sleep 3
fi 
fi



duong_dan_thu_muc_sql="/usr/local/backup-website/$NAME/$filesql"


check_file_error=$(du -c $duong_dan_thu_muc_sql | awk '{print $1}' | sed '1d')
if (( $check_file_error < 10 ));then
echo "$filesql bi loi khong the su dung de khoi phuc database"
echo "Vui long lua chon file database backup khac"
exit
fi

clear
echo "Dang tien hanh khoi phuc database website $NAME ..."
mysql -u "$database_admin_username" -p"$database_admin_password" -e "DROP DATABASE IF EXISTS ${DB_Name_web}"
mysql -u "$database_admin_username" -p"$database_admin_password" -e "CREATE DATABASE IF NOT EXISTS ${DB_Name_web}"
mysql -u "$database_admin_username" -p"$database_admin_password" -e "DROP USER IF EXISTS '${DB_User_web}'@'localhost'"
mysql -u "$database_admin_username" -p"$database_admin_password" -e "CREATE USER IF NOT EXISTS '${DB_User_web}'@'localhost' IDENTIFIED BY '${DB_Password_web}'"
mysql -u "$database_admin_username" -p"$database_admin_password" -e "GRANT ALL PRIVILEGES ON ${DB_Name_web}.* TO '${DB_User_web}'@'localhost' WITH GRANT OPTION"
mysql -u "$database_admin_username" -p"$database_admin_password" -e "FLUSH PRIVILEGES"

#khôi phục database bằng định đang .sql thông thường
if [[ $sql_gz = '' ]];then
mysql -u "$DB_User_web" -p"$DB_Password_web" "$DB_Name_web" <$duong_dan_thu_muc_sql
fi

#khôi phục database bằng định dạng .sql.gz được config
if [[ $sql_gz ]];then
zcat $duong_dan_thu_muc_sql | mysql -u "$DB_User_web" -p"$DB_Password_web" "$DB_Name_web"
fi


echo "Hoàn tất khôi phục thành công database website $NAME"

echo "Tiến hành khôi phục mã nguồn website $NAME"
rm -rf /usr/local/lsws/"$NAME"/html/*
unzip -n "$duong_dan_thu_muc" -d /usr/local/lsws/"$NAME"/html/

echo "Hoàn tất khôi phục mã nguồn thành công website $NAME"
rm -rf /usr/local/lsws/"$NAME"/luucache

echo "Tiến hành phân quyền website $NAME ..."
chown -R "$User_name_vhost":"$User_name_vhost" /usr/local/lsws/"$NAME"/html
find /usr/local/lsws/"$NAME"/html -type d -exec chmod 755 {} \;
find /usr/local/lsws/"$NAME"/html -type f -exec chmod 644 {} \;
echo "Hoan tat phan quyen website $NAME"
if [[ -f /usr/local/lsws/$NAME/html/wp-config.php ]]; then

kiemtradau=$(cat /usr/local/lsws/$NAME/html/wp-config.php | grep 'DB_NAME' | grep "\"")
if [[ $kiemtradau ]];then
sed -i "/DB_NAME/s/\"/'/g" "/usr/local/lsws/$NAME/html/wp-config.php"
sed -i "/DB_HOST/s/\"/'/g" "/usr/local/lsws/$NAME/html/wp-config.php"
sed -i "/DB_USER/s/\"/'/g" "/usr/local/lsws/$NAME/html/wp-config.php"
sed -i "/DB_PASSWORD/s/\"/'/g" "/usr/local/lsws/$NAME/html/wp-config.php"
fi

sed -i "/DB_HOST/s/'[^']*'/'localhost'/2" "/usr/local/lsws/$NAME/html/wp-config.php"
sed -i "/DB_NAME/s/'[^']*'/'$DB_Name_web'/2" "/usr/local/lsws/$NAME/html/wp-config.php"
sed -i "/DB_USER/s/'[^']*'/'$DB_User_web'/2" "/usr/local/lsws/$NAME/html/wp-config.php"
sed -i "/DB_PASSWORD/s/'[^']*'/'$DB_Password_web'/2" "/usr/local/lsws/$NAME/html/wp-config.php"
wp rewrite flush --allow-root --path=/usr/local/lsws/"$NAME"/html >/dev/null 2>&1
else
echo "khong xac dinh duoc file wp-config.php"
echo "Co ve nhu day khong phai website wordpress"
fi
/usr/local/lsws/bin/lswsctrl restart >/dev/null 2>&1

pathcheckwp="/usr/local/lsws/$NAME/html/wp-load.php"
if [[ -f $pathcheckwp ]];then
. /etc/wptt/cache/wptt-xoacache $NAME
fi

clear
. /etc/wptt/echo-color
echo "==================================================================="
echoDone "Khôi phục website $NAME thành công             "
echo "==================================================================="

check_menu_wptangtoc_active=$1
if [[ $check_menu_wptangtoc_active = "98" ]];then
. /etc/wptt/wptt-backup-restore-main 1
fi

