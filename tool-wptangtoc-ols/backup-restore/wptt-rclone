#!/bin/bash
# @author: Gia Tuấn
# @website: https://wptangtoc.com
# @email: giatuan@wptangtoc.com
# @since: 2022
clear
echo ""
echo ""
echo ""
echo "==================================================================================="
echo "|Sao lưu & khôi phục => Thiết lập Rclone backup lưu trữ đám mây Google Driver 	|"
echo "==================================================================================="
echo ""
echo ""

. /etc/wptt/echo-color
if [[ ! -d /root/.config ]];then
mkdir -p /root/.config
chmod 751 /root/.config
fi

duong_dan_rclone="/root/.config/rclone/rclone.conf"
if [[ ! -f $duong_dan_rclone ]]; then
	_runing "Cài đặt Rclone"
	echo ''
	echo '               .::------------:--                
               -==-------------=##+               
              -====-----------+####*.             
            .=======---------+######*.            
           .=========-------*#########:           
          .============----*###########-          
         :==============--*#############-         
        :===============-+###############=        
       -===============:  =###############+       
      -===============:    =###############+      
     -===============:      -###############*.    
   .================.        :###############*.   
  .================.          :################:  
 .===============-.            .*###############: 
:===============-                +###############-
----------------:................:+***************
:--------------==================================:
 :------------==================================: 
  .----------==================================:  
   .-------===================================:   
    .-----===================================.    
      :--===================================.     
       .-================================-:       
'
	cd /tmp
	rm -f install.sh
	curl -sO https://rclone.org/install.sh && bash install.sh
	rm -f install.sh
phienban=1.55.0
wget https://downloads.rclone.org/v${phienban}/rclone-v${phienban}-linux-amd64.zip
unzip -o rclone-v${phienban}-linux-amd64.zip
cd rclone-v${phienban}-linux-amd64
cp -r rclone /usr/sbin/
chmod 755 /usr/sbin/rclone
	_rundone "Cài đặt Rclone"
fi


checkdathietlap=$(grep -rnw '/root/.config/rclone/rclone.conf' -e "wptangtoc" >>/dev/null 2>&1 && echo 2)
if [[ $checkdathietlap ]]; then
	clear
	echo "Bạn đã cấu hình rclone trước đó rồi"
	. /etc/wptt/wptt-backup-restore-main 1
	exit
fi


echo "Copy https://wptangtoc.com/xac-thuc-google-drive/ sau đó paste vào trình duyệt để đã đăng nhập tài khoản google để lấy id:"

#link được rút ngon bên trên
# https://accounts.google.com/o/oauth2/auth?access_type=offline&client_id=202264815644.apps.googleusercontent.com&redirect_uri=urn%3Aietf%3Awg%3Aoauth%3A2.0%3Aoob&response_type=code&scope=https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fdrive&state=YG0NAAApdaOSGLL5PoCXqA

read -p "Nhập mã id của bạn [0=Thoat]: " checkid

if [[ "$checkid" = "0" ]]; then
. /etc/wptt/wptt-backup-restore-main 1
	clear
	exit
fi

if [[ "$checkid" = "" ]]; then
. /etc/wptt/wptt-backup-restore-main 1
	clear
	exit
fi

_runing "Thiết lập Google Driver"
checktool="/usr/bin/expect"
if [[ ! -f $checktool ]]; then
	yum install expect -y >/dev/null 2>&1
fi

thietlap=$(expect -c "
spawn /usr/sbin/rclone config
expect \"n\"
send \"n\r\"
expect \"name\"
send \"wptangtoc\r\"
expect \"Storage\"
send \"drive\r\"
expect \"client_id\"
send \"\r\"
expect \"client_secret\"
send \"\r\"
expect \"scope\"
send \"1\r\"
expect \"root_folder_id\"
send \"\r\"
expect \"service_account_file\"
send \"\r\"
expect \"n\"
send \"n\r\"
expect \"n\"
send \"n\r\"
expect \"verification\"
send \"$checkid\r\"
expect \"n\"
send \"n\r\"
expect \"n\"
send \"y\r\"
expect eof
")

checkdathietlapxacthuc=$(grep -rnw '/root/.config/rclone/rclone.conf' -e "wptangtoc" >>/dev/null 2>&1 && echo 2)
if [[ $checkdathietlapxacthuc ]]; then
	_rundone "Thiết lập Google Driver"
else
	_runloi "Thiết lập Google Driver"
fi

check_menu_wptangtoc_active=$1
if [[ $check_menu_wptangtoc_active = "98" ]];then
. /etc/wptt/wptt-backup-restore-main 1
fi

