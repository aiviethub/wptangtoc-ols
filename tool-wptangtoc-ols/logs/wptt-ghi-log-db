#!/bin/bash
# @author: Gia Tu·∫•n
# @since: 2025

function huong_dan(){
T√≠nh nƒÉng Ghi Log Database MariaDB
Ghi log [logging] trong MariaDB l√† qu√° tr√¨nh m√°y ch·ªß c∆° s·ªü d·ªØ li·ªáu t·ª± ƒë·ªông ghi l·∫°i c√°c s·ª± ki·ªán, truy v·∫•n, l·ªói, v√† c√°c th√¥ng tin ho·∫°t ƒë·ªông kh√°c v√†o c√°c t·ªáp tin log. ƒêi·ªÅu n√†y r·∫•t h·ªØu √≠ch cho vi·ªác qu·∫£n tr·ªã v√† b·∫£o tr√¨ h·ªá th·ªëng.

C√°c lo·∫°i log ch√≠nh v√† c√¥ng d·ª•ng:
Error Log [Log l·ªói]:
 * N·ªôi dung: Ghi l·∫°i c√°c l·ªói x·∫£y ra khi MariaDB kh·ªüi ƒë·ªông, d·ª´ng, ho·∫∑c c√°c l·ªói nghi√™m tr·ªçng trong qu√° tr√¨nh ho·∫°t ƒë·ªông.
 * C√¥ng d·ª•ng: Gi√∫p ch·∫©n ƒëo√°n c√°c s·ª± c·ªë c·ªßa m√°y ch·ªß. ƒê√¢y l√† log quan tr·ªçng nh·∫•t v√† th∆∞·ªùng ƒë∆∞·ª£c b·∫≠t m·∫∑c ƒë·ªãnh.

General Query Log [Log truy v·∫•n chung - GQL]:
 * N·ªôi dung: Ghi l·∫°i m·ªçi k·∫øt n·ªëi v√† c√¢u l·ªánh SQL ƒë∆∞·ª£c th·ª±c thi tr√™n m√°y ch·ªß.
 * C√¥ng d·ª•ng: R·∫•t h·ªØu √≠ch ƒë·ªÉ g·ª° l·ªói ·ª©ng d·ª•ng [xem ch√≠nh x√°c nh·ªØng truy v·∫•n n√†o ƒëang ƒë∆∞·ª£c g·ª≠i ƒë·∫øn DB] ho·∫∑c ƒë·ªÉ ki·ªÉm tra ho·∫°t ƒë·ªông chi ti·∫øt. L∆∞u √Ω: B·∫≠t log n√†y c√≥ th·ªÉ l√†m gi·∫£m ƒë√°ng k·ªÉ hi·ªáu nƒÉng v√† t·ªën nhi·ªÅu dung l∆∞·ª£ng ƒëƒ©a, n√™n th∆∞·ªùng ch·ªâ b·∫≠t t·∫°m th·ªùi khi c·∫ßn.

Slow Query Log [Log truy v·∫•n ch·∫≠m]:
 * N·ªôi dung: Ghi l·∫°i c√°c c√¢u l·ªánh SQL m·∫•t nhi·ªÅu th·ªùi gian h∆°n m·ªôt ng∆∞·ª°ng nh·∫•t ƒë·ªãnh ƒë·ªÉ th·ª±c thi [v√≠ d·ª•: h∆°n 1 gi√¢y].
 * C√¥ng d·ª•ng: Gi√∫p x√°c ƒë·ªãnh v√† t·ªëi ∆∞u h√≥a c√°c truy v·∫•n g√¢y ch·∫≠m h·ªá th·ªëng.

Binary Log [Log nh·ªã ph√¢n - Binlog]:
 * N·ªôi dung: Ghi l·∫°i t·∫•t c·∫£ c√°c thay ƒë·ªïi ƒë·ªëi v·ªõi d·ªØ li·ªáu [INSERT, UPDATE, DELETE] v√† c·∫•u tr√∫c b·∫£ng [CREATE, ALTER, DROP]. Kh√¥ng ghi l·∫°i c√°c l·ªánh SELECT kh√¥ng thay ƒë·ªïi d·ªØ li·ªáu.
 * C√¥ng d·ª•ng: C·ª±c k·ª≥ quan tr·ªçng cho vi·ªác sao ch√©p [replication] d·ªØ li·ªáu sang m√°y ch·ªß kh√°c v√† cho vi·ªác kh√¥i ph·ª•c d·ªØ li·ªáu t·∫°i m·ªôt th·ªùi ƒëi·ªÉm c·ª• th·ªÉ [point-in-time recovery].

T·∫°i sao n√™n b·∫≠t ghi log?
 * G·ª° l·ªói [Troubleshooting]: Nhanh ch√≥ng t√¨m ra nguy√™n nh√¢n l·ªói c·ªßa ·ª©ng d·ª•ng ho·∫∑c c·ªßa ch√≠nh MariaDB.
 * Ph√¢n t√≠ch hi·ªáu nƒÉng [Performance Analysis]: Ph√°t hi·ªán c√°c truy v·∫•n kh√¥ng hi·ªáu qu·∫£.
 * Ki·ªÉm to√°n b·∫£o m·∫≠t [Security Auditing]: Theo d√µi ai ƒë√£ l√†m g√¨ v·ªõi d·ªØ li·ªáu [m·∫∑c d√π ƒë·ªÉ ki·ªÉm to√°n chi ti·∫øt h∆°n c√≥ th·ªÉ c·∫ßn plugin Audit].
 * Kh·∫£ nƒÉng ph·ª•c h·ªìi d·ªØ li·ªáu [Data Recovery]: Binlog l√† n·ªÅn t·∫£ng cho vi·ªác n√†y.

Ghi ch√∫: üíæ Dung l∆∞·ª£ng ƒëƒ©a: C√°c t·ªáp log c√≥ th·ªÉ ph√°t tri·ªÉn r·∫•t nhanh. C·∫ßn c√≥ k·∫ø ho·∫°ch qu·∫£n l√Ω log
}

echo ""
echo ""
echo ""
echo "========================================================================="
echo "|Qu·∫£n l√Ω Logs => Ghi logs database                                      |"
echo "========================================================================="
echo ""
echo ""

check=$(cat /etc/my.cnf.d/server.cnf | grep -c "skip-log-bin")

if [[ "$check" = "0" ]];then
echo "B·∫°n ƒë√£ k√≠ch ho·∫°t t√≠nh nƒÉng ghi logs database"
sleep 3
. /etc/wptt/wptt-logs-main
exit
fi

echo "X√°c nh·∫≠n ghi log database: "
prompt="Nh·∫≠p l·ª±a ch·ªçn c·ªßa b·∫°n [1-2]: "
dongy="n"
options=("ƒê·ªìng √Ω" "Kh√¥ng ƒë·ªìng √Ω")
PS3="$prompt"
select opt in "${options[@]}"; do
	case "$REPLY" in
		1)
			dongy="y"
			break
			;;

		2)
			dongy="n"
			break
			;;

		$((${#options[@]} + 1)))
			printf "\nB·∫°n nh·∫≠p sai h·ªá th·ªëng s·∫Ω ch·ªçn l√† kh√¥ng ƒë·ªìng √Ω\n"
			break
			;;
		*)
			printf "B·∫°n nh·∫≠p sai h·ªá th·ªëng s·∫Ω ch·ªçn l√† kh√¥ng ƒë·ªìng √Ω\n"
			break
			;;
	esac
done



if [[ "$dongy" = "y" ]];then
echo "B·∫≠t ghi log database : $(date '+%d-%m-%Y %H:%M')" >> /var/log/wptangtoc-ols.log

mkdir -p /var/log/mysql
chown mysql:mysql /var/log/mysql

echo "log-bin=/var/log/mysql/mysql-bin.log
general-log=/var/log/mysql/mysql.log
log-error=/var/log/mysql/mysql-error.log
slow-query-log = 1
slow-query-log-file=/var/log/mysql/mysql-slow.log
long_query_time = 1" >> /etc/my.cnf.d/server.cnf
sed -i '/skip-log-bin/d' /etc/my.cnf.d/server.cnf

systemctl restart mariadb.service

echo "========================================================================="
echo "Ho√†n t·∫•t ghi logs database"
echo "========================================================================="
echo "File logs database general        : /var/log/mysql/mysql.log"
echo "File logs database log-bin        : /var/log/mysql/mysql-bin.log"
echo "File logs database log-error      : /var/log/mysql/mysql-error.log"
echo "File logs truy van cham database  : /var/log/mysql/mysql-slow.log"
echo "========================================================================="
else
. /etc/wptt/wptt-logs-main
fi

check_menu_wptangtoc_active=$1
if [[ $check_menu_wptangtoc_active = "98" ]];then
. /etc/wptt/wptt-logs-main 1
fi

