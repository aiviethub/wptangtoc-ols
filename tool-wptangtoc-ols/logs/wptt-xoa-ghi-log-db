#!/bin/bash
# @author: Gia Tu·∫•n
# @website: https://wptangtoc.com
# @since: 2025

function huong_dan(){
T√≠nh nƒÉng T·∫Øt ghi log database cho ph√©p ng∆∞·ªùi d√πng c·∫•u h√¨nh h·ªá qu·∫£n tr·ªã c∆° s·ªü d·ªØ li·ªáu [MariaDB] ƒë·ªÉ ng·ª´ng vi·ªác ghi l·∫°i c√°c ho·∫°t ƒë·ªông, truy v·∫•n, ho·∫∑c l·ªói v√†o c√°c t·ªáp nh·∫≠t k√Ω [log files].

C√°c lo·∫°i log database ph·ªï bi·∫øn bao g·ªìm:
 * General Query Log: Ghi l·∫°i m·ªçi truy v·∫•n ƒë∆∞·ª£c g·ª≠i ƒë·∫øn database.
 * Slow Query Log: Ghi l·∫°i c√°c truy v·∫•n ch·∫°y ch·∫≠m h∆°n m·ªôt ng∆∞·ª°ng th·ªùi gian nh·∫•t ƒë·ªãnh.
 * Error Log: Ghi l·∫°i c√°c l·ªói khi kh·ªüi ƒë·ªông, ch·∫°y, ho·∫∑c d·ª´ng database.
 * Binary Log [Binlog]: Ghi l·∫°i m·ªçi thay ƒë·ªïi ƒë·ªëi v·ªõi d·ªØ li·ªáu [quan tr·ªçng cho sao l∆∞u v√† nh√¢n b·∫£n].

M·ª•c ƒë√≠ch ch√≠nh c·ªßa vi·ªác t·∫Øt ghi log database l√†:
 * C·∫£i thi·ªán hi·ªáu su·∫•t [Performance]: üöÄ Vi·ªác ghi log, ƒë·∫∑c bi·ªát l√† General Query Log v√† Binary Log tr√™n c√°c h·ªá th·ªëng c√≥ l∆∞·ª£ng truy c·∫≠p l·ªõn, ti√™u t·ªën t√†i nguy√™n I/O v√† CPU. T·∫Øt ch√∫ng c√≥ th·ªÉ gi√∫p database ch·∫°y nhanh h∆°n.
 * Ti·∫øt ki·ªám dung l∆∞·ª£ng ·ªï c·ª©ng: üíæ C√°c t·ªáp log, nh·∫•t l√† General Log v√† Binlog, c√≥ th·ªÉ ph√°t tri·ªÉn r·∫•t l·ªõn. T·∫Øt ch√∫ng gi√∫p ti·∫øt ki·ªám kh√¥ng gian l∆∞u tr·ªØ.

 T√≥m l·∫°i, T·∫Øt ghi log database l√† m·ªôt c√¥ng c·ª• gi√∫p t·ªëi ∆∞u hi·ªáu su·∫•t v√† dung l∆∞·ª£ng, nh∆∞ng n√≥ ƒë√°nh ƒë·ªïi b·∫±ng kh·∫£ nƒÉng g·ª° l·ªói, ph·ª•c h·ªìi v√† ki·ªÉm to√°n. H√£y hi·ªÉu r√µ h·∫≠u qu·∫£ tr∆∞·ªõc khi s·ª≠ d·ª•ng.
}

echo ""
echo ""
echo ""
echo "========================================================================="
echo "|Qu·∫£n l√Ω Logs => H·ªßy k√≠ch ho·∫°t ghi logs database                        |"
echo "========================================================================="
echo ""
echo ""

check=$(cat /etc/my.cnf.d/server.cnf | grep -c "skip-log-bin")
if [[ "$check" = "1" ]];then
echo "Ban chua kich hoat tinh nang ghi logs database"
sleep 3
. /etc/wptt/wptt-logs-main
exit
fi

echo "X√°c nh·∫≠n t·∫Øt t√≠nh nƒÉng ghi logs database"
prompt="Nh·∫≠p l·ª±a ch·ªçn c·ªßa b·∫°n [1-2]: "
dongy="n"
options=("ƒê·ªìng √Ω" "Kh√¥ng ƒë·ªìng √Ω")
PS3="$prompt"
select opt in "${options[@]}"; do
	case "$REPLY" in
		1)
			dongy="y"
			break
			;;

		2)
			dongy="n"
			break
			;;

		$((${#options[@]} + 1)))
			printf "\nB·∫°n nh·∫≠p sai h·ªá th·ªëng s·∫Ω ch·ªçn l√† kh√¥ng ƒë·ªìng √Ω\n"
			break
			;;
		*)
			printf "B·∫°n nh·∫≠p sai h·ªá th·ªëng s·∫Ω ch·ªçn l√† kh√¥ng ƒë·ªìng √Ω\n"
			break
			;;
	esac
done


if [[ "$dongy" = "y" ]];then
sed -i '/log-bin/d' /etc/my.cnf.d/server.cnf
sed -i '/\[mysqld\]/a skip-log-bin' /etc/my.cnf.d/server.cnf
sed -i '/slow-query-log/d' /etc/my.cnf.d/server.cnf
sed -i '/slow-query-log-file/d' /etc/my.cnf.d/server.cnf
sed -i '/long_query_time/d' /etc/my.cnf.d/server.cnf
sed -i '/general-log/d' /etc/my.cnf.d/server.cnf
sed -i '/mysql-error.log/d' /etc/my.cnf.d/server.cnf

systemctl restart mariadb.service
echo "========================================================================="
echo "Ho√†n t·∫•t h·ªßy k√≠ch ho·∫°t ghi database"
echo "========================================================================="
else
. /etc/wptt/wptt-logs-main 1
fi


check_menu_wptangtoc_active=$1
if [[ $check_menu_wptangtoc_active = "98" ]];then
. /etc/wptt/wptt-logs-main 1
fi

