#!/bin/bash
pwd=$(pwd)
if [[ ! -f $pwd/wp-config.php ]]; then
    echo "Chua truy cap vao duong dan ma nguon website"
    cd
    ls --color=auto
    read -p "Nhap duong nhan ma nguon website: " NAME
    pwd=$(pwd)
    pwd="$pwd/$NAME"
fi

if [[ -f $pwd/wp-config.php ]]; then
    rm -f $pwd/giatuan-wptangtoc.zip
    cd $pwd && zip -r $pwd/giatuan-wptangtoc.zip * -x "wp-content/ai1wm-backups/*" -x "wp-content/cache/*" -x "wp-content/updraft/*"
    mysqldump -u $(cat $pwd/wp-config.php | grep DB_USER | cut -d \' -f4) -p"$(cat $pwd/wp-config.php | grep DB_PASSWORD | cut -d \' -f4)" $(cat $pwd/wp-config.php | grep DB_NAME | cut -d \' -f4) --single-transaction --quick --lock-tables=false >$pwd/giatuan-wptangtoc.sql
    database="$pwd/giatuan-wptangtoc.zip"
    database2="$pwd/giatuan-wptangtoc.zip"
    if [[ ! -f "$database" ]]; then
        echo "qua trinh bi loi"
        rm -f wptt
        exit
    else
        echo "Hoan tat sao luu"
        echo "Hay Tai file ve webserver bang cach, paste doan lenh nay vao terminal VPS moi cua ban muon chuyen vao"
        tuan=$(wp option get siteurl --allow-root --path=$pwd | cut -f2 -d ":" | cut -c 3-100)
        echo "=================================================================="
        if [[ $tuan ]]; then
            tuan2=$(wp option get siteurl --allow-root --path=$pwd | cut -f1 -d ":")
            echo "wget -P /usr/local/backup-website/$tuan $tuan2://$tuan/giatuan-wptangtoc.zip"
            echo "wget -P /usr/local/backup-website/$tuan $tuan2://$tuan/giatuan-wptangtoc.sql"
        else
            echo "wget -P /usr/local/backup-website/domain.com http://domain.com/giatuan-wptangtoc.zip"
            echo "wget -P /usr/local/backup-website/domain.com http://domain.com/giatuan-wptangtoc.sql"
        fi
        if [[ $tuan = "" ]]; then
            echo "Ghi chu hay thay domain.com bang ten mien cua ban"
        fi
        echo "=================================================================="
        echo "xong roi vao tinh nang khoi phuc cua wptangtoc ols de khoi phuc"
        read -p "xac nhan da tai xong file webserver, xoa file backup (y/n): " dongyluon
        if [[ "$dongyluon" = "y" ]]; then
            rm -f $pwd/$database
            rm -f $pwd/$database2
            rm -f wptt
            echo "Hoan tat"
        fi
    fi
else
    echo "hay truy cap vao thu muc ma nguon cua website roi su dung lenh"
    rm -f wptt
fi
